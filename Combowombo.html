<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üìä Rekap SA Sim3lon ‚Äî Rekap & SPBE</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root{
    --card:#ffffff;
    --muted:#64748b;
    --accent:#3b82f6; /* biru muda */
    --accent-light:#e0f2fe;
  }

  body{
    font-family:"Inter",system-ui,-apple-system,"Segoe UI",Roboto;
    background:linear-gradient(180deg,#e0f2fe,#f8fbff);
    min-height:100vh;
    padding:14px;
  }

  .container{max-width:1200px;margin:0 auto;}
  .card{
    background:var(--card);
    border-radius:16px;
    padding:18px;
    box-shadow:0 6px 18px rgba(59,130,246,0.08);
    animation:fadeIn .3s ease;
  }

  /* TABLE */
  .scroll-container{overflow:auto;max-height:70vh;border-radius:10px;}
  table{border-collapse:collapse;width:100%;min-width:850px;font-size:13px;}
  th,td{padding:10px;border:1px solid #e2e8f0;text-align:center;white-space:nowrap;}
  thead th{
    background:linear-gradient(90deg,#0284c7,#38bdf8);
    color:#fff;
    position:sticky;top:0;z-index:5;
    font-weight:600;
  }

  tbody tr:hover td{background:#f0f9ff;}

  tbody td:first-child, thead th:first-child{
    position:sticky;left:0;background:#f0f9ff;z-index:6;text-align:left;font-weight:600;
  }
  tbody td:nth-child(2), thead th:nth-child(2){
    position:sticky;left:160px;background:#f9fbff;z-index:5;text-align:left;
  }

  .spbe-row{background:#fffbea;}
  .spbe-total{background:#fef3c7;font-weight:700;}
  .sisa-row{background:#dcfce7;font-weight:700;}

  /* BUTTON */
  .btn{
    background:var(--accent);
    color:#fff;
    padding:10px 14px;
    border-radius:12px;
    font-weight:600;
    display:inline-flex;
    align-items:center;
    gap:6px;
    box-shadow:0 4px 
 box-shadow:0 4px 12px rgba(59,130,246,0.25);
    transition:all .15s ease;
  }
  .btn:hover{transform:translateY(-1px);box-shadow:0 6px 14px rgba(59,130,246,0.3);}
  .btn:active{transform:translateY(1px);}
  .btn.ghost{
    background:transparent;
    color:var(--accent);
    border:1px solid #bfdbfe;
    box-shadow:none;
  }
  .small{padding:6px 10px;font-size:13px;border-radius:8px;}

  /* MODAL */
  .modal{
    position:fixed;inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background:rgba(0,0,0,0.45);
    z-index:50;
    backdrop-filter:blur(4px);
    padding:16px;
  }
  .modal-inner{
    background:#fff;
    border-radius:14px;
    width:100%;
    max-width:420px;
    padding:18px;
    box-shadow:0 8px 30px rgba(0,0,0,0.15);
    animation:fadeIn .25s ease;
  }

  .chk-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;}
  .chk-item:hover{background:#f1f5f9;}

  /* SPINNER */
  #spinner{
    display:none;
    position:fixed;
    inset:0;
    z-index:60;
    background:rgba(255,255,255,0.75);
    backdrop-filter:blur(3px);
    align-items:center;
    justify-content:center;
  }
  .dot{
    width:48px;height:48px;border-radius:50%;
    border:5px solid #dbeafe;
    border-top-color:var(--accent);
    animation:spin 1s linear infinite;
  }
  @keyframes spin{to{transform:rotate(360deg)}}

  /* TEXT & UTILITY */
  .muted{color:var(--muted);}
  .green-ok{color:#16a34a;font-weight:700;}
  .red-bad{color:#dc2626;font-weight:700;}

  @keyframes fadeIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:none;}}

  /* RESPONSIVE */
  @media(max-width:900px){
    .filters-row{flex-direction:column;gap:8px;}
    table{min-width:700px;}
  }
  @media(max-width:640px){
    table{min-width:600px;}
    h1{font-size:1.1rem;}
  }
</style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="flex items-center justify-between gap-4 mb-4 flex-wrap">
        <div>
          <h1 class="text-xl font-bold text-sky-700">üìä Rekap SA Sim3lon</h1>
          <p class="muted text-sm">Rekap, Jadwal Harian & Pengiriman (SPBE, stok, dsb)</p>
        </div>
        <div class="flex gap-2 items-center">
          <button class="btn small" onclick="downloadCSV()">‚¨á Export CSV</button>
          <button class="btn ghost small" onclick="clearFilters()">Reset</button>
        </div>
      </div>

      <!-- FILTER -->
      <div class="flex filters-row flex-wrap gap-3 mb-3 items-center">
        <select id="month" class="p-2 rounded-lg border border-slate-200 focus:ring-2 focus:ring-sky-300">
          <option value="1">Jan</option><option value="2">Feb</option><option value="3">Mar</option><option value="4">Apr</option>
          <option value="5">Mei</option><option value="6">Jun</option><option value="7">Jul</option><option value="8">Agu</option>
          <option value="9">Sep</option><option value="10">Okt</option><option value="11">Nov</option><option value="12">Des</option>
        </select>

        <select id="year" class="p-2 rounded-lg border border-slate-200 focus:ring-2 focus:ring-sky-300"></select>

        <div class="flex items-center gap-2">
          <label class="muted text-sm">Dari</label>
          <input id="startDate" type="date" class="p-2 rounded-lg border border-slate-200 focus:ring-2 focus:ring-sky-300" />
        </div>
        <div class="flex items-center gap-2">
          <label class="muted text-sm">Sampai</label>
          <input id="endDate" type="date" class="p-2 rounded-lg border border-slate-200 focus:ring-2 focus:ring-sky-300" />
        </div>

        <div class="ml-auto flex gap-2 flex-wrap">
          <button class="btn small" onclick="openModal('pangkalan')">üè† Pilih Pangkalan</button>
          <button class="btn small" onclick="openModal('pt')">üè¢ Pilih PT</button>
          <button class="btn small" onclick="loadRekap()">üîç Tampilkan</button>
        </div>
      </div>

      <p id="note" class="muted text-xs mb-3">üí° Pilih banyak pangkalan / PT via checkbox ‚Äî tanpa tahan CTRL.</p>

      <div id="spinner" class="flex">
        <div style="text-align:center">
          <div class="dot"></div>
          <p class="muted mt-2">Memuat data...</p>
        </div>
      </div>

      <div id="tabel-wrapper" class="fade-in">
        <div id="tabel-container" class="scroll-container card p-0 mt-2"></div>
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div id="modal" class="modal">
    <div class="modal-inner">
      <div class="flex justify-between items-center mb-2">
        <strong id="modalTitle" class="text-sky-700">Pilih</strong>
        <div class="flex gap-1">
          <button class="small btn ghost" onclick="checkAll()">All</button>
          <button class="small btn ghost" onclick="uncheckAll()">None</button>
        </div>
      </div>
      <div id="modalList" class="max-h-[60vh] overflow-auto border rounded-lg p-2 border-slate-100"></div>
      <div class="flex justify-end mt-3">
        <button class="btn small" onclick="closeModal()">Selesai</button>
      </div>
    </div>
  </div>

  <script>
  // === JS tetap sama, hanya UI-nya dirapikan ===
  const endpoint = 'https://script.google.com/macros/s/AKfycby44Vx6YH0Nh3IncvJ91z4nhBwHVNI-i61NdqyK5EgpEQtKtTLGtz1b2_Fz5r1PA2g1Pw/exec';
  const yearSelect = document.getElementById('year');
  const currentYear = new Date().getFullYear();
  for(let y=currentYear-2;y<=currentYear+1;y++){
    const o=document.createElement('option');
    o.value=y;o.textContent=y;
    if(y===currentYear)o.selected=true;
    yearSelect.appendChild(o);
  }
  document.getElementById('month').value = new Date().getMonth()+1;

  let allPangkalan=[], allPT=[], modalType='';

  function populateFilters(data, spbeArr){
    const pangkalanSet=new Set(), ptSet=new Set();
    data.forEach(r=>{if(r.namaPangkalan)pangkalanSet.add(r.namaPangkalan);if(r.namaPT)ptSet.add(r.namaPT);});
    (spbeArr||[]).forEach(s=>{if(s.namaPT)ptSet.add(s.namaPT);});
    allPangkalan=[...pangkalanSet].sort(); allPT=[...ptSet].sort();
  }

  function openModal(type){
    modalType=type;
    const title=document.getElementById('modalTitle');
    const list=document.getElementById('modalList');
    list.innerHTML='';
    title.textContent=type==='pangkalan'?'Pilih Pangkalan':'Pilih PT';
    const arr=type==='pangkalan'?allPangkalan:allPT;
    arr.forEach(v=>{
      const id=`opt-${type}-${hashCode(v)}`;
      const div=document.createElement('div');
      div.className='chk-item';
      div.innerHTML=`<label style="display:flex;align-items:center;gap:10px;width:100%">
        <input id="${id}" type="checkbox" class="option-${type}" value="${escapeHtml(v)}" />
        <span style="flex:1">${escapeHtml(v)}</span>
      </label>`;
      list.appendChild(div);
    });
    document.getElementById('modal').style.display='flex';
  }
  function closeModal(){document.getElementById('modal').style.display='none';}
  function checkAll(){document.querySelectorAll(\`.option-\${modalType}\`).forEach(c=>c.checked=true);}
  function uncheckAll(){document.querySelectorAll(\`.option-\${modalType}\`).forEach(c=>c.checked=false);}

  function loadRekap(){
    const month=document.getElementById('month').value;
    const year=document.getElementById('year').value;
    const start=document.getElementById('startDate').value;
    const end=document.getElementById('endDate').value;
    document.getElementById('spinner').style.display='flex';
    document.getElementById('tabel-container').innerHTML='';
    let url=\`\${endpoint}?action=getRekapGabungan&month=\${month}&year=\${year}\`;
    if(start)url+=\`&startDate=\${start}\`;
    if(end)url+=\`&endDate=\${end}\`;
    url+=\`&callback=renderTableJSONP\`;
    const script=document.createElement('script');
    script.src=url;
    document.body.appendChild(script);
  }

  function renderTableJSONP(json){
    document.getElementById('spinner').style.display='none';
    if(json.status!=='ok'){
      document.getElementById('tabel-container').innerHTML=\`<div class="card p-4 text-center text-slate-500">‚ùå \${escapeHtml(json.message||'Error')}</div>\`;
      return;
    }
    const info=json.info||{};
    populateFilters(info.result||[],info.spbe||[]);
    renderTable(info);
  }

  function escapeHtml(s){return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');}
  function hashCode(str){let h=0;for(let i=0;i<str.length;i++){h=(h<<5)-h+str.charCodeAt(i);h|=0;}return Math.abs(h);}
  function clearFilters(){document.getElementById('startDate').value='';document.getElementById('endDate').value='';document.querySelectorAll('.option-pangkalan,.option-pt').forEach(i=>i.checked=false);loadRekap();}
  function downloadCSV(){
    const table=document.querySelector('#tabel-container table');
    if(!table){alert('Tidak ada tabel untuk diexport');return;}
    let csv=[];for(const row of table.rows){const cols=[...row.cells].map(c=>'"'+c.innerText.replace(/"/g,'""')+'"');csv.push(cols.join(','));}
    const blob=new Blob([csv.join('\n')],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');a.href=url;a.download=\`rekap_\${Date.now()}.csv\`;a.click();URL.revokeObjectURL(url);
  }

  // panggil awal
  loadRekap();
  </script>
</body>
</html>
