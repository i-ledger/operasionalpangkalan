<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üìä Rekap SA Sim3lon ‚Äî Rekap & SPBE</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root {
    --accent: #0284c7;
    --accent-light: #e0f2fe;
    --border: #e2e8f0;
    --muted: #64748b;
  }

  body {
    font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto;
    background: #f8fafc;
    color: #1e293b;
    margin: 0;
    padding: 12px;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
  }

  .card {
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px;
    box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
  }

  /* --------- Table --------- */
  .scroll-container {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    border-radius: 8px;
    border: 1px solid var(--border);
  }

  table {
    border-collapse: collapse;
    width: 100%;
    font-size: 13px;
    min-width: 700px;
  }

  th,
  td {
    padding: 8px 10px;
    border: 1px solid var(--border);
    text-align: center;
    white-space: nowrap;
  }

  thead th {
    background: var(--accent);
    color: #fff;
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 5;
  }

  tbody tr:hover td {
    background: var(--accent-light);
  }

  tbody td:first-child,
  thead th:first-child {
    position: sticky;
    left: 0;
    background: #f0f9ff;
    z-index: 6;
    text-align: left;
    font-weight: 600;
  }

  tbody td:nth-child(2),
  thead th:nth-child(2) {
    position: sticky;
    left: 160px;
    background: #f8fafc;
    z-index: 5;
    text-align: left;
  }

  .spbe-row {
    background: #fef9c3;
  }

  .spbe-total {
    background: #fde68a;
    font-weight: 700;
  }

  .sisa-row {
    background: #dcfce7;
    font-weight: 700;
  }

  /* -------- Buttons -------- */
  .btn {
    background: var(--accent);
    color: #fff;
    padding: 10px 14px;
    border-radius: 8px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: background 0.15s ease, transform 0.15s ease;
  }
  .btn:hover {
    background: #0369a1;
  }
  .btn:active {
    transform: scale(0.97);
  }

  .btn.ghost {
    background: transparent;
    color: var(--accent);
    border: 1px solid var(--accent);
  }

  .small {
    padding: 6px 10px;
    font-size: 13px;
  }

  /* -------- Modal -------- */
  .modal {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 50;
  }

  .modal-inner {
    background: #fff;
    border-radius: 10px;
    padding: 16px;
    width: 100%;
    max-width: 400px;
    max-height: 80vh;
    overflow-y: auto;
  }

  .chk-item {
    padding: 8px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .chk-item:hover {
    background: #f1f5f9;
  }

  /* -------- Spinner -------- */
  #spinner {
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.45);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 60;
  }

  .dot {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 4px solid #e2e8f0;
    border-top-color: var(--accent);
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  /* -------- Responsive -------- */
  @media (max-width: 768px) {
    body {
      padding: 8px;
    }
    .filters-row {
      flex-direction: column;
      gap: 6px;
    }
    table {
      font-size: 12px;
    }
    .btn {
      width: 100%;
    }
  }

  .muted {
    color: var(--muted);
  }

  .green-ok {
    color: #15803d;
    font-weight: 700;
  }

  .red-bad {
    color: #b91c1c;
    font-weight: 700;
  }
</style>
</head>

<body>
  <div class="container">
    <div class="card">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-3">
        <div>
          <h1 class="text-lg font-semibold">üìä Rekap SA Sim3lon</h1>
          <p class="muted text-sm">Rekap Jadwal Harian dan Pengiriman ‚Äî SPBE & Stok</p>
        </div>
        <div class="flex gap-2 flex-wrap">
          <button class="btn small" onclick="downloadCSV()">‚¨á Export CSV</button>
          <button class="btn ghost small" onclick="clearFilters()">Reset</button>
        </div>
      </div>

      <!-- Filters -->
      <div class="flex flex-wrap items-center gap-2 mb-3 filters-row">
        <select id="month" class="p-2 rounded border border-slate-300">
          <option value="1">Jan</option><option value="2">Feb</option><option value="3">Mar</option><option value="4">Apr</option>
          <option value="5">Mei</option><option value="6">Jun</option><option value="7">Jul</option><option value="8">Agu</option>
          <option value="9">Sep</option><option value="10">Okt</option><option value="11">Nov</option><option value="12">Des</option>
        </select>

        <select id="year" class="p-2 rounded border border-slate-300"></select>

        <input id="startDate" type="date" class="p-2 rounded border border-slate-300" />
        <input id="endDate" type="date" class="p-2 rounded border border-slate-300" />

        <div class="flex gap-2 ml-auto flex-wrap">
          <button class="btn small" onclick="openModal('pangkalan')">üè† Pangkalan</button>
          <button class="btn small" onclick="openModal('pt')">üè¢ PT</button>
          <button class="btn small" onclick="loadRekap()">üîç Tampilkan</button>
        </div>
      </div>

      <p class="text-xs muted mb-2">Pilih banyak Pangkalan / PT melalui checkbox ‚Äî tanpa tahan CTRL.</p>

      <div id="spinner" class="flex">
        <div class="text-center">
          <div class="dot mx-auto mb-2"></div>
          <div class="text-white text-sm">Memuat data...</div>
        </div>
      </div>

      <div id="tabel-wrapper">
        <div id="tabel-container" class="scroll-container"></div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal">
    <div class="modal-inner">
      <div class="flex justify-between items-center mb-2">
        <strong id="modalTitle">Pilih</strong>
        <div class="flex gap-1">
          <button class="btn ghost small" onclick="checkAll()">All</button>
          <button class="btn ghost small" onclick="uncheckAll()">None</button>
        </div>
      </div>
      <div id="modalList"></div>
      <div class="flex justify-end mt-3">
        <button class="btn small" onclick="closeModal()">Selesai</button>
      </div>
    </div>
  </div>

<script>
/* ---------- CONFIG ---------- */
const endpoint = 'https://script.google.com/macros/s/AKfycby44Vx6YH0Nh3IncvJ91z4nhBwHVNI-i61NdqyK5EgpEQtKtTLGtz1b2_Fz5r1PA2g1Pw/exec';
const yearSelect = document.getElementById('year');
const currentYear = new Date().getFullYear();
for(let y=currentYear-2;y<=currentYear+1;y++){
  const o=document.createElement('option');o.value=y;o.textContent=y;
  if(y===currentYear)o.selected=true; yearSelect.appendChild(o);
}
document.getElementById('month').value = new Date().getMonth()+1;

/* state */
let allPangkalan=[], allPT=[];
let modalType = ''; // 'pangkalan' or 'pt'

/* Populate filter arrays from backend result */
function populateFilters(data, spbeArr){
  const pangkalanSet=new Set();
  const ptSet=new Set();
  data.forEach(row=>{
    if(row.namaPangkalan) pangkalanSet.add(row.namaPangkalan);
    if(row.namaPT) ptSet.add(row.namaPT);
  });
  // include PT from SPBE rows too
  (spbeArr||[]).forEach(s => { if(s.namaPT) ptSet.add(s.namaPT); });

  allPangkalan = Array.from(pangkalanSet).sort();
  allPT = Array.from(ptSet).sort();
}

/* ---------- MODAL ---------- */
function openModal(type){
  modalType = type;
  const title = document.getElementById('modalTitle');
  const list = document.getElementById('modalList');
  list.innerHTML = '';
  title.textContent = type==='pangkalan' ? 'Pilih Pangkalan' : 'Pilih PT';
  const arr = type==='pangkalan' ? allPangkalan : allPT;
  arr.forEach(v=>{
    const id = `opt-${type}-${hashCode(v)}`;
    const div = document.createElement('div');
    div.className = 'chk-item';
    div.innerHTML = `<label style="display:flex;align-items:center;gap:10px;width:100%">
      <input id="${id}" type="checkbox" class="option-${type}" value="${escapeHtml(v)}" />
      <span style="flex:1">${escapeHtml(v)}</span>
    </label>`;
    list.appendChild(div);
  });
  // show modal
  document.getElementById('modal').style.display = 'flex';
}
function closeModal(){
  document.getElementById('modal').style.display='none';
}
function checkAll(){
  document.querySelectorAll(`.option-${modalType}`).forEach(c=>c.checked=true);
}
function uncheckAll(){
  document.querySelectorAll(`.option-${modalType}`).forEach(c=>c.checked=false);
}

/* ---------- LOAD / RENDER ---------- */
function loadRekap(){
  const month=document.getElementById('month').value;
  const year=document.getElementById('year').value;
  const start=document.getElementById('startDate').value;
  const end=document.getElementById('endDate').value;

  document.getElementById('spinner').style.display='flex';
  document.getElementById('tabel-container').innerHTML='';

  let url = `${endpoint}?action=getRekapGabungan&month=${month}&year=${year}`;
  if(start) url += `&startDate=${start}`;
  if(end) url += `&endDate=${end}`;
  url += `&callback=renderTableJSONP`;

  const script = document.createElement('script');
  script.src = url;
  document.body.appendChild(script);
}

function renderTableJSONP(json){
  document.getElementById('spinner').style.display='none';
  if(json.status !== 'ok'){
    document.getElementById('tabel-container').innerHTML = `<div class="card" style="padding:16px"><p class="muted">‚ùå ${escapeHtml(json.message||'Error')}</p></div>`;
    return;
  }
  const info = json.info || {};
  populateFilters(info.result || [], info.spbe || []);
  renderTable(info);
}

/* helper safe text */
function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function hashCode(str){ let h=0; for(let i=0;i<str.length;i++){h=(h<<5)-h+str.charCodeAt(i);h|=0;} return Math.abs(h); }

/* main renderer */
function renderTable(info){
  const container = document.getElementById('tabel-container');
  const tanggalSet = info.tanggalSet || [];
  let data = (info.result || []).slice();
  let spbeData = (info.spbe || []).slice();

  // get checked options from modal inputs (if none checked -> all)
  const checkedPangkalan = Array.from(document.querySelectorAll('.option-pangkalan:checked')).map(i=>i.value);
  const checkedPT = Array.from(document.querySelectorAll('.option-pt:checked')).map(i=>i.value);

  if(checkedPangkalan.length) data = data.filter(r=>checkedPangkalan.includes(r.namaPangkalan));
  if(checkedPT.length){ data = data.filter(r=>checkedPT.includes(r.namaPT)); spbeData = spbeData.filter(s=>checkedPT.includes(s.namaPT)); }

  // filter spbe rows that have any non-zero in tanggalSet
  spbeData = spbeData.filter(sp=>tanggalSet.some(tgl => Number(sp.data[tgl]||0) > 0));

  if(tanggalSet.length===0 || (data.length===0 && spbeData.length===0)){
    container.innerHTML = `<div class="card" style="padding:18px;text-align:center"><p class="muted">Tidak ada data untuk filter ini.</p></div>`;
    return;
  }

  // build table
  let html = `<table><thead><tr>
    <th rowspan="2">Nama Pangkalan</th>
    <th rowspan="2">Nama PT</th>`;
  tanggalSet.forEach(tgl => html += `<th colspan="3">${escapeHtml(tgl)}</th>`);
  html += `<th rowspan="2">Œ£ SA‚ÄìJH</th><th rowspan="2">Œ£ JH‚ÄìP</th></tr><tr>`;
  tanggalSet.forEach(()=> html += `<th>SA</th><th>JH</th><th>P</th>`);
  html += `</tr></thead><tbody>`;

  const totalPerTanggal = {}; tanggalSet.forEach(t=> totalPerTanggal[t]={SA:0,JH:0,IS:0});

  // rows per pangkalan
  data.forEach(row=>{
    let totalSA = 0, totalJH = 0, totalIS = 0;
    html += `<tr><td style="text-align:left">${escapeHtml(row.namaPangkalan)}</td><td style="text-align:left">${escapeHtml(row.namaPT)}</td>`;
    tanggalSet.forEach(tgl=>{
      const isi = row.data[tgl] || {};
      const valSA = Number(isi.SA||0);
      const valJH = Number(isi.JH||0);
      const valIS = Number(isi.IS||0);
      totalSA += valSA; totalJH += valJH; totalIS += valIS;
      totalPerTanggal[tgl].SA += valSA;
      totalPerTanggal[tgl].JH += valJH;
      totalPerTanggal[tgl].IS += valIS;
      html += `<td>${valSA||'-'}</td><td>${valJH||'-'}</td><td>${valIS?valIS+' üöö':'-'}</td>`;
    });
    const sj = totalSA - totalJH;
    const sp = totalJH - totalIS;
    html += `<td class="${sj!==0 ? 'red-bad' : 'green-ok'}">${sj}</td><td class="${sp!==0 ? 'red-bad' : 'green-ok'}">${sp}</td></tr>`;
  });

  // TOTAL utama (per tanggal) + grand totals
  html += `<tr class="card" style="background:#eef7ff;font-weight:700"><td colspan="2">TOTAL</td>`;
  let grandSA=0, grandJH=0, grandIS=0;
  tanggalSet.forEach(t=>{
    const tTotals = totalPerTanggal[t];
    grandSA += tTotals.SA; grandJH += tTotals.JH; grandIS += tTotals.IS;
    html += `<td>${tTotals.SA||0}</td><td>${tTotals.JH||0}</td><td>${tTotals.IS? tTotals.IS+' üöö' : '-'}</td>`;
  });
  const totalSJ = grandSA - grandJH;
  const totalSP = grandJH - grandIS;
  html += `<td class="${totalSJ!==0?'red-bad':'green-ok'}">${totalSJ}</td><td class="${totalSP!==0?'red-bad':'green-ok'}">${totalSP}</td></tr>`;

  // === SPBE rows (warna kuning) ===
  if(spbeData.length>0){
    const totalSPBE = {}; tanggalSet.forEach(t=> totalSPBE[t]=0);
    spbeData.forEach(sp=>{
      html += `<tr class="spbe-row"><td style="text-align:left">${escapeHtml(sp.namaSPBE)}</td><td style="text-align:left">${escapeHtml(sp.namaPT||'-')}</td>`;
      tanggalSet.forEach(t=>{
        const v = Number(sp.data[t]||0);
        totalSPBE[t] += v;
        html += `<td colspan="3">${v||'-'}</td>`;
      });
      html += `<td colspan="2"></td></tr>`;
    });

    // TOTAL SPBE
    html += `<tr class="spbe-total"><td colspan="2">TOTAL SPBE</td>`;
    tanggalSet.forEach(t=>{
      html += `<td colspan="3">${totalSPBE[t]||0}</td>`;
    });
    html += `<td colspan="2"></td></tr>`;

    // SISA / STOK GUDANG
    let sisaPrev = 0;
    html += `<tr class="sisa-row"><td colspan="2">SISA / STOK GUDANG</td>`;
    tanggalSet.forEach((t,i)=>{
      const totalP = totalPerTanggal[t].IS || 0;
      const masuk = totalSPBE[t] || 0;
      const sisaNow = i===0 ? masuk - totalP : (sisaPrev + masuk) - totalP;
      sisaPrev = sisaNow;
      html += `<td colspan="3">${sisaNow}</td>`;
    });
    html += `<td colspan="2"></td></tr>`;
  }

  html += `</tbody></table>`;
  container.innerHTML = html;
}

/* ---------- small utilities ---------- */
function clearFilters(){
  document.getElementById('startDate').value='';
  document.getElementById('endDate').value='';
  // uncheck any modal checkboxes (if present)
  document.querySelectorAll('.option-pangkalan, .option-pt').forEach(i=>i.checked=false);
  loadRekap();
}

/* export CSV simple (flattened) */
function downloadCSV(){
  // quick export of displayed HTML table
  const table = document.querySelector('#tabel-container table');
  if(!table){ alert('Tidak ada tabel untuk diexport'); return; }
  let csv = [];
  for(const row of table.rows){
    const cols = Array.from(row.cells).map(c => '"'+c.innerText.replace(/"/g,'""')+'"');
    csv.push(cols.join(','));
  }
  const blob = new Blob([csv.join('\n')], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `rekap_${Date.now()}.csv`; a.click(); URL.revokeObjectURL(url);
}

/* helpers safe */
function escapeHtml(s){ return String(s||''); }

/* init */
loadRekap();
</script>
</body>
</html>
