<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üìä Rekap SA Sim3lon</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body {
    font-family: 'Inter', sans-serif;
    background: linear-gradient(180deg, #f0f9ff, #dbeafe);
    min-height: 100vh;
    padding-bottom: 60px;
  }

  .scroll-container {
    overflow-x: auto;
    overflow-y: auto;
    max-height: 80vh;
    -webkit-overflow-scrolling: touch;
  }

  table { border-collapse: collapse; min-width: 100%; font-size: 12px; }
  th, td { border: 1px solid #e5e7eb; padding: 6px 8px; text-align: center; white-space: nowrap; }
  thead th { background: #3b82f6; color: white; position: sticky; top: 0; z-index: 3; }
  td img { width: 40px; border-radius: 6px; }

  #spinner {
    display: none;
    position: fixed; inset: 0; z-index: 50;
    background: rgba(0,0,0,0.3);
    justify-content: center; align-items: center; flex-direction: column;
  }
  .spinner-circle {
    border: 4px solid #bfdbfe;
    border-top: 4px solid #3b82f6;
    border-radius: 50%;
    width: 50px; height: 50px;
    animation: spin 1s linear infinite;
    margin-bottom: 10px;
  }
  @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }

  /* Custom button look */
  .btn {
    @apply bg-blue-600 text-white font-semibold rounded-lg px-4 py-2 transition duration-200;
  }
  .btn:hover {
    @apply bg-blue-700 shadow-md;
  }

  /* Modal style */
  .modal {
    display: none;
    position: fixed;
    z-index: 100;
    inset: 0;
    background: rgba(0,0,0,0.4);
    justify-content: center;
    align-items: center;
  }
  .modal-content {
    background: white;
    border-radius: 1rem;
    padding: 1rem;
    width: 90%;
    max-width: 400px;
    max-height: 80vh;
    overflow-y: auto;
  }
</style>
</head>
<body class="p-4">

<h1 class="text-2xl font-bold mb-4 text-blue-900 text-center">
  üìä Rekap SA Sim3lon, Jadwal Harian & Pengiriman
</h1>

<!-- FILTER AREA -->
<div class="bg-white shadow-md rounded-xl p-4 mb-4 flex flex-wrap gap-3 justify-center">
  <select id="month" class="border rounded-lg p-2 text-sm">
    <option value="1">Januari</option><option value="2">Februari</option>
    <option value="3">Maret</option><option value="4">April</option>
    <option value="5">Mei</option><option value="6">Juni</option>
    <option value="7">Juli</option><option value="8">Agustus</option>
    <option value="9">September</option><option value="10">Oktober</option>
    <option value="11">November</option><option value="12">Desember</option>
  </select>

  <select id="year" class="border rounded-lg p-2 text-sm"></select>

  <div class="flex items-center gap-2">
    <label class="text-sm text-gray-600">Dari:</label>
    <input type="date" id="startDate" class="border rounded-lg p-2 text-sm">
    <label class="text-sm text-gray-600">Sampai:</label>
    <input type="date" id="endDate" class="border rounded-lg p-2 text-sm">
  </div>

  <button onclick="openModal('pangkalan')" class="btn">üè† Pilih Pangkalan</button>
  <button onclick="openModal('pt')" class="btn">üè¢ Pilih PT</button>
  <button onclick="loadRekap()" class="btn">üîç Tampilkan</button>
</div>

<!-- SPINNER -->
<div id="spinner" class="flex">
  <div class="spinner-circle"></div>
  <span class="text-white text-lg font-semibold">Memuat data...</span>
</div>

<!-- TABLE -->
<div id="tabel-container" class="scroll-container bg-white rounded-xl shadow-md p-3"></div>

<!-- MODAL PANGKALAN/PT -->
<div id="modal" class="modal flex">
  <div class="modal-content">
    <h2 id="modalTitle" class="text-lg font-semibold text-blue-700 mb-2"></h2>
    <div id="modalList" class="space-y-1"></div>
    <div class="mt-3 flex justify-end">
      <button class="btn" onclick="closeModal()">Selesai</button>
    </div>
  </div>
</div>

<script>
const endpoint = 'https://script.google.com/macros/s/AKfycby44Vx6YH0Nh3IncvJ91z4nhBwHVNI-i61NdqyK5EgpEQtKtTLGtz1b2_Fz5r1PA2g1Pw/exec';
const filterPangkalan = document.createElement('select');
const filterPT = document.createElement('select');
const yearSelect = document.getElementById('year');
const currentYear = new Date().getFullYear();

for (let y = currentYear - 2; y <= currentYear + 1; y++) {
  const opt = document.createElement('option');
  opt.value = y; opt.textContent = y;
  if (y === currentYear) opt.selected = true;
  yearSelect.appendChild(opt);
}
document.getElementById('month').value = new Date().getMonth()+1;

let allPangkalan = [];
let allPT = [];

function openModal(type) {
  const modal = document.getElementById('modal');
  const modalList = document.getElementById('modalList');
  const title = document.getElementById('modalTitle');
  modalList.innerHTML = '';

  const list = type === 'pangkalan' ? allPangkalan : allPT;
  title.textContent = type === 'pangkalan' ? 'Pilih Pangkalan' : 'Pilih PT';

  list.forEach(item => {
    const div = document.createElement('div');
    div.innerHTML = `<label class="flex items-center gap-2">
      <input type="checkbox" class="option-${type}" value="${item}">
      <span>${item}</span>
    </label>`;
    modalList.appendChild(div);
  });

  modal.style.display = 'flex';
}
function closeModal() {
  document.getElementById('modal').style.display = 'none';
}

function populateFilters(data){
  const pangkalanSet=new Set();
  const ptSet=new Set();
  data.forEach(row=>{pangkalanSet.add(row.namaPangkalan); ptSet.add(row.namaPT)});
  allPangkalan = Array.from(pangkalanSet);
  allPT = Array.from(ptSet);
}

function loadRekap(){
  const month=document.getElementById('month').value;
  const year=document.getElementById('year').value;
  const start=document.getElementById('startDate').value;
  const end=document.getElementById('endDate').value;

  document.getElementById('spinner').style.display='flex';
  document.getElementById('tabel-container').innerHTML='';

  let url = `${endpoint}?action=getRekapGabungan&month=${month}&year=${year}`;
  if(start) url += `&startDate=${start}`;
  if(end) url += `&endDate=${end}`;
  url += `&callback=renderTableJSONP`;

  const script=document.createElement('script');
  script.src=url;
  document.body.appendChild(script);
}

function renderTableJSONP(json){
  document.getElementById('spinner').style.display='none';
  if(json.status!=='ok'){
    document.getElementById('tabel-container').innerHTML=`<p class='text-red-500 text-center'>‚ùå ${json.message}</p>`;
    return;
  }
  if(allPangkalan.length===0) populateFilters(json.info.result);
  renderTable(json.info);
}

function renderTable(info) {
  const container = document.getElementById('tabel-container');
  const tanggalSet = info.tanggalSet || [];
  let data = info.result || [];
  let spbeData = info.spbe || [];

  // ambil pilihan user dari modal
  const selectedPangkalan = Array.from(document.querySelectorAll('.option-pangkalan:checked')).map(c=>c.value);
  const selectedPT = Array.from(document.querySelectorAll('.option-pt:checked')).map(c=>c.value);

  if (selectedPangkalan.length)
    data = data.filter(r => selectedPangkalan.includes(r.namaPangkalan));
  if (selectedPT.length) {
    data = data.filter(r => selectedPT.includes(r.namaPT));
    spbeData = spbeData.filter(sp => selectedPT.includes(sp.namaPT));
  }

  if (tanggalSet.length === 0 || (data.length === 0 && spbeData.length === 0)) {
    container.innerHTML = `<p class='text-gray-500 text-center'>Tidak ada data untuk filter ini.</p>`;
    return;
  }

  // HEADER
  let html = `<table><thead><tr>
    <th rowspan="2">Nama Pangkalan</th>
    <th rowspan="2">Nama PT</th>`;
  tanggalSet.forEach(tgl => html += `<th colspan="3">${tgl}</th>`);
  html += `<th rowspan="2">Œ£ SA‚ÄìJH</th><th rowspan="2">Œ£ JH‚ÄìP</th></tr><tr>`;
  tanggalSet.forEach(() => html += `<th>SA</th><th>JH</th><th>P</th>`);
  html += `</tr></thead><tbody>`;

  const totalPerTanggal = {};
  tanggalSet.forEach(tgl => totalPerTanggal[tgl] = { SA: 0, JH: 0, IS: 0 });

  data.forEach(row => {
    let totalSA = 0, totalJH = 0, totalIS = 0;
    html += `<tr><td>${row.namaPangkalan}</td><td>${row.namaPT}</td>`;
    tanggalSet.forEach(tgl => {
      const isi = row.data[tgl] || {};
      const valSA = Number(isi.SA || 0);
      const valJH = Number(isi.JH || 0);
      const valIS = Number(isi.IS || 0);
      totalSA += valSA;
      totalJH += valJH;
      totalIS += valIS;
      html += `<td>${valSA}</td><td>${valJH}</td><td>${valIS}</td>`;
      totalPerTanggal[tgl].SA += valSA;
      totalPerTanggal[tgl].JH += valJH;
      totalPerTanggal[tgl].IS += valIS;
    });
    const sj = totalSA - totalJH;
    const sp = totalJH - totalIS;
    html += `<td class="${sj!=0?'text-red-600 font-bold':''}">${sj}</td>
             <td class="${sp!=0?'text-red-600 font-bold':''}">${sp}</td></tr>`;
  });

  html += `</tbody></table>`;
  container.innerHTML = html;
}

loadRekap();
</script>
</body>
</html>
