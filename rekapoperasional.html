<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Rekap Operasional ‚Äî i-Shipping</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #rekap-table tbody tr:nth-child(even){ background:#f9fafb; }
    #rekap-table tbody tr:nth-child(odd){ background:#fff; }
    #rekap-table th, #rekap-table td { white-space:nowrap; }
    @media (max-width:900px){ #rekap-table { font-size:12px } }
  </style>
</head>
<body class="bg-blue-50 min-h-screen p-4 font-sans">
  <div class="max-w-6xl mx-auto">
    <header class="flex items-center justify-between mb-4 bg-blue-200 p-3 rounded-lg shadow">
      <div class="flex items-center gap-3">
        <div id="logo" class="w-10 h-10 bg-white rounded flex items-center justify-center text-blue-700 font-bold">iL</div>
        <h1 class="text-xl font-bold text-blue-900">üìä Rekap Operasional ‚Äî i-Shipping</h1>
      </div>
      <div class="flex items-center gap-2">
        <button id="btn-refresh" class="px-3 py-1 bg-gray-100 rounded text-sm">üîÑ Refresh</button>
        <button onclick="goDashboard()" class="px-3 py-1 bg-blue-600 text-white text-sm rounded-lg shadow hover:bg-blue-700">üè† Dashboard</button>
      </div>
    </header>

    <div id="spinner" class="hidden fixed inset-0 bg-black bg-opacity-40 flex flex-col items-center justify-center z-50">
      <svg class="animate-spin h-12 w-12 text-blue-400 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
      </svg>
      <span id="spinner-text" class="text-white text-lg font-semibold">Loading...</span>
    </div>

    <section class="bg-white p-4 rounded-xl shadow mb-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-medium text-blue-900">Nama PT</label>
          <select id="select-pt" class="mt-1 block w-full rounded-md border-gray-300"></select>
        </div>
        <div>
          <label class="block text-sm font-medium text-blue-900">Nama Pangkalan</label>
          <select id="select-pangkalan" multiple size="5" class="mt-1 block w-full rounded-md border-gray-300"></select>
        </div>
        <div>
          <label class="block text-sm font-medium text-blue-900">Bulan</label>
          <select id="select-month" class="mt-1 block w-full rounded-md border-gray-300"></select>
        </div>
        <div>
          <label class="block text-sm font-medium text-blue-900">Tahun</label>
          <select id="select-year" class="mt-1 block w-full rounded-md border-gray-300"></select>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-2 md:grid-cols-6 gap-4 text-center">
        <div class="bg-blue-100 p-3 rounded-lg shadow"><div class="text-xs text-gray-600">DO yang dimiliki</div><div id="do-owned" class="text-lg font-semibold">-</div></div>
        <div class="bg-blue-100 p-3 rounded-lg shadow"><div class="text-xs text-gray-600">Harga Tabung</div><div id="price" class="text-lg font-semibold">-</div></div>
        <div class="bg-blue-100 p-3 rounded-lg shadow"><div class="text-xs text-gray-600">Harga Bagi Hasil</div><div id="harga-bagi-hasil" class="text-lg font-semibold">-</div></div>
        <div class="bg-blue-100 p-3 rounded-lg shadow"><div class="text-xs text-gray-600">Total Penerimaan</div><div id="total-penerimaan" class="text-lg font-semibold">-</div></div>
        <div class="bg-blue-100 p-3 rounded-lg shadow"><div class="text-xs text-gray-600">Tabung Kerjasama</div><div id="tabung-kerjasama" class="text-lg font-semibold">-</div></div>
        <div class="bg-blue-100 p-3 rounded-lg shadow"><div class="text-xs text-gray-600">Sisa Bagi Hasil</div><div id="sisa-bagi-hasil" class="text-lg font-semibold">-</div></div>
      </div>

      <div class="mt-4 flex flex-wrap gap-2 items-center">
        <button id="btn-load" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700">üîé Tampilkan Rekap</button>
        <button id="btn-export-csv" class="px-4 py-2 border border-blue-400 text-blue-700 rounded-lg shadow">üì• Export CSV</button>
        <button id="btn-export-pdf" class="px-4 py-2 border bg-indigo-600 text-white rounded-lg shadow">üìÑ Export PDF</button>
        <button id="btn-share-wa" class="px-4 py-2 border bg-green-600 text-white rounded-lg shadow">üì§ Share WA</button>
        <div class="text-sm text-gray-500 ml-auto">Data cached ‚Äî klik Refresh untuk ambil terbaru</div>
      </div>
    </section>

    <section id="rekap-wrapper" class="bg-white p-4 rounded-xl shadow">
      <div class="overflow-auto">
        <table id="rekap-table" class="min-w-full border border-gray-300">
          <thead class="bg-blue-200 text-blue-900 font-bold">
            <tr>
              <th class="px-3 py-2 border">Tanggal</th>
              <th class="px-3 py-2 border">Laporan Driver</th>
              <th class="px-3 py-2 border">Retur</th>
              <th class="px-3 py-2 border">Dikirim</th>
              <th class="px-3 py-2 border">SA Pangkalan</th>
              <th class="px-3 py-2 border">Pengiriman</th>
              <th class="px-3 py-2 border">Nominal Dibayar</th>
              <th class="px-3 py-2 border">Brimola Oleh</th>
              <th class="px-3 py-2 border">Bayar Brimola</th>
              <th class="px-3 py-2 border">Bukti TF</th>
              <th class="px-3 py-2 border">Bagi Hasil</th>
              <th class="px-3 py-2 border text-blue-900">Total TBG</th>
            </tr>
          </thead>
          <tbody id="rekap-body" class="bg-white"></tbody>
          <tfoot class="bg-blue-100 font-semibold">
            <tr>
              <td colspan="5" class="px-3 py-2 text-right border">TOTAL</td>
              <td id="total-pengiriman" class="px-3 py-2 border text-right">0</td>
              <td></td><td></td><td></td><td></td>
              <td id="total-bagi-hasil" class="px-3 py-2 border text-right">0</td>
              <td id="grand-total" class="px-3 py-2 border text-right text-blue-800">0</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>
  </div>

<script>
/* ========== CONFIG ========== */
const GAS_URL = "https://script.google.com/macros/s/AKfycbxWrvXPaOobkmsHBUzXQVXPU23E6LMpbqhFZugBhJX_e7WeCD9RGHYRRnR9fTmdRm3Q9Q/exec";
const APP_CACHE = { pts:[], pangkalanByPT:{}, doInfo:null, rekap:null, rawFetchedAt:null };

/* ========== HELPERS ========== */
const SPINNER = document.getElementById('spinner');
const SPINNER_TEXT = document.getElementById('spinner-text');
function showSpinner(text){ if(text) SPINNER_TEXT.textContent = text; SPINNER.classList.remove('hidden'); }
function hideSpinner(){ SPINNER.classList.add('hidden'); }
function goDashboard(){ window.location.href = "dashboard.html"; }
function safeNum(v){ return Number(v)||0; }
function formatRupiah(val){ if(val===null||val===undefined||Number(val)===0) return '-'; return 'Rp '+Number(val).toLocaleString('id-ID'); }

/* ========== FETCH (single) ========== */
async function fetchAll(params={}){
  const q = new URLSearchParams({ action:'getAllData', ...params });
  showSpinner('Mengambil data...');
  try {
    const res = await fetch(`${GAS_URL}?${q}`, { cache: 'no-store' });
    const data = await res.json();
    console.log('DEBUG: server responded', data);
    // tolerate different shapes: if data has .rekap but no .pts, try to recover
    APP_CACHE.pts = data.pts && data.pts.length ? data.pts : (data.pangkalanByPT ? Object.keys(data.pangkalanByPT) : ['ALL']);
    APP_CACHE.pangkalanByPT = data.pangkalanByPT || {};
    APP_CACHE.doInfo = data.doInfo || (data.rekap && { do_owned: data.rekap.do_owned || 0, harga_tabung: data.rekap.harga_tabung || null, harga_bagi_hasil: data.rekap.harga_bagi_hasil || null }) || { do_owned:0 };
    APP_CACHE.rekap = data.rekap || (data.rows ? { rows: data.rows, total_penerimaan: data.total_penerimaan||0 } : { rows:[], total_penerimaan:0 });
    APP_CACHE.rawFetchedAt = new Date().toISOString();
    return APP_CACHE;
  } catch(err) {
    console.error('fetchAll error', err);
    alert('Gagal ambil data dari server: ' + (err.message||err));
    // fallback: set minimal defaults so UI tetap usable
    APP_CACHE.pts = APP_CACHE.pts.length ? APP_CACHE.pts : ['ALL'];
    APP_CACHE.pangkalanByPT = APP_CACHE.pangkalanByPT || {};
    APP_CACHE.doInfo = APP_CACHE.doInfo || { do_owned:0 };
    APP_CACHE.rekap = APP_CACHE.rekap || { rows:[], total_penerimaan:0 };
    return null;
  } finally {
    hideSpinner();
  }
}

/* ========== DOM helpers ========== */
function makeMonthOptions(){
  const sel = document.getElementById('select-month'); sel.innerHTML='';
  const months=['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
  const now = new Date();
  months.forEach((m,i)=>{ const o=document.createElement('option'); o.value=i+1; o.textContent=m; if(i===now.getMonth()) o.selected=true; sel.appendChild(o); });
}
function makeYearOptions(){
  const sel=document.getElementById('select-year'); sel.innerHTML=''; const yNow=new Date().getFullYear();
  for(let y=yNow-2;y<=yNow+1;y++){ const o=document.createElement('option'); o.value=y; o.textContent=y; if(y===yNow)o.selected=true; sel.appendChild(o); }
}
function populatePTs(){
  const sel=document.getElementById('select-pt'); sel.innerHTML='';
  (APP_CACHE.pts||[]).forEach(pt=>{ const o=document.createElement('option'); o.value=pt; o.textContent=pt; sel.appendChild(o); });
  if(!sel.options.length){ const o=document.createElement('option'); o.value='ALL'; o.textContent='ALL'; sel.appendChild(o); }
}
function populatePangkalanForSelectedPT(){
  const pt=document.getElementById('select-pt').value||'ALL';
  const list = APP_CACHE.pangkalanByPT && APP_CACHE.pangkalanByPT[pt] ? APP_CACHE.pangkalanByPT[pt] : [];
  const sel=document.getElementById('select-pangkalan'); sel.innerHTML='';
  const all=document.createElement('option'); all.value='ALL'; all.textContent='-- Semua Pangkalan --'; all.selected=true; sel.appendChild(all);
  if(list && list.length){ list.forEach(p=>{ const o=document.createElement('option'); o.value=p; o.textContent=p; sel.appendChild(o); }); }
}
function getSelectedPangkalan(){ const sel=document.getElementById('select-pangkalan'); const vals=Array.from(sel.selectedOptions||[]).map(o=>o.value); if(vals.length===0) return ['ALL']; if(vals.includes('ALL')) return ['ALL']; return vals; }

/* ========== Filtering & rendering ========== */
function filterCachedRekap(){
  let rows = (APP_CACHE.rekap && APP_CACHE.rekap.rows) ? APP_CACHE.rekap.rows.slice() : [];

  const month = Number(document.getElementById('select-month').value) || (new Date().getMonth()+1);
  const year = Number(document.getElementById('select-year').value) || new Date().getFullYear();
  const selectedPT = (document.getElementById('select-pt').value || 'ALL').trim().toLowerCase();
  const selectedPangkalan = getSelectedPangkalan().map(v => v.trim().toLowerCase());

  // filter by month/year (tanggal format expected dd/MM/yyyy)
  rows = rows.filter(r=>{
    const t = String(r.tanggal||'').trim();
    if(!t) return true;
    const parts = t.split('/');
    if(parts.length<3) return true;
    const m = Number(parts[1]); const y = Number(parts[2]);
    return (m===month && y===year);
  });

  // filter by PT
  if(selectedPT !== 'all'){
    rows = rows.filter(r => (r.pt||'').trim().toLowerCase() === selectedPT);
  }

  // filter by pangkalan
  if(selectedPangkalan.length && !selectedPangkalan.includes('all')){
    rows = rows.filter(r => selectedPangkalan.includes((r.pangkalan||'').trim().toLowerCase()));
  }

  return rows;
}

function renderTableAndSummary(rows){
  const tbody=document.getElementById('rekap-body'); tbody.innerHTML='';
  let grandTotal=0, totalPengiriman=0, totalBagiHasil=0;
  (rows||[]).forEach(r=>{
    const bayarBrimola = safeNum(r.bayar_lewat_brimola);
    const nominalHarusDibayar = safeNum(r.nominal_harus_dibayar);
    const buktiTransfer = safeNum(r.bukti_transfer);
    const pengiriman = safeNum(r.pengiriman);
    const bagiHasil = safeNum(r.bagi_hasil);
    const totalTBG = bayarBrimola - nominalHarusDibayar + buktiTransfer;
    grandTotal += totalTBG; totalPengiriman += pengiriman; totalBagiHasil += bagiHasil;
    const tr=document.createElement('tr');
    tr.innerHTML = `<td class="px-3 py-2 text-sm">${r.tanggal||''}</td>
      <td class="px-3 py-2 text-sm">${r.laporan_pengiriman||''}</td>
      <td class="px-3 py-2 text-sm">${r.retur||0}</td>
      <td class="px-3 py-2 text-sm">${r.dikirim||''}</td>
      <td class="px-3 py-2 text-sm">${r.master_sa||0}</td>
      <td class="px-3 py-2 text-sm text-right">${pengiriman}</td>
      <td class="px-3 py-2 text-sm text-right">${formatRupiah(nominalHarusDibayar)}</td>
      <td class="px-3 py-2 text-sm">${r.brimola_oleh||''}</td>
      <td class="px-3 py-2 text-sm text-right">${formatRupiah(bayarBrimola)}</td>
      <td class="px-3 py-2 text-sm text-right">${formatRupiah(buktiTransfer)}</td>
      <td class="px-3 py-2 text-sm text-right">${formatRupiah(bagiHasil)}</td>
      <td class="px-3 py-2 text-sm text-right text-blue-600 font-semibold">${formatRupiah(totalTBG)}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('total-pengiriman').textContent = totalPengiriman;
  document.getElementById('total-bagi-hasil').textContent = totalBagiHasil ? formatRupiah(totalBagiHasil) : '0';
  document.getElementById('grand-total').textContent = grandTotal ? formatRupiah(grandTotal) : '0';
  return { totalPengiriman, totalBagiHasil, grandTotal };
}

function updateInfoBoxesFromCache(totals){
  const doInfo = APP_CACHE.doInfo || {};
  const rekap = APP_CACHE.rekap || {};
  document.getElementById('do-owned').textContent = safeNum(doInfo.do_owned) || '-';
  document.getElementById('price').innerHTML = doInfo.harga_tabung ? formatRupiah(doInfo.harga_tabung) : '-';
  document.getElementById('harga-bagi-hasil').innerHTML = doInfo.harga_bagi_hasil ? formatRupiah(doInfo.harga_bagi_hasil) : '-';
  document.getElementById('total-penerimaan').textContent = safeNum(rekap.total_penerimaan) || '-';
  const tP = safeNum(rekap.total_penerimaan); const dO = safeNum(doInfo.do_owned); const hrgBagi = safeNum(doInfo.harga_bagi_hasil);
  const sudahBayar = safeNum(totals && totals.totalBagiHasil) || 0;
  const tabungKerjasama = tP - dO;
  const nominalBagiHasil = tabungKerjasama * hrgBagi;
  const sisa = nominalBagiHasil - sudahBayar;
  document.getElementById('tabung-kerjasama').textContent = tabungKerjasama !== 0 ? (tabungKerjasama + ' Tbg') : '-';
  document.getElementById('sisa-bagi-hasil').innerHTML = sisa ? formatRupiah(sisa) : '-';
}

/* ========== CSV / PDF / WA (keperluan lain) ========== */
/* kept same as before - omitted here for brevity in debug; you already have working code above */
function exportCSV(){
  const rows = Array.from(document.querySelectorAll('#rekap-table tr')).map(tr=>Array.from(tr.querySelectorAll('th,td')).map(td=>td.innerText.replace(/\n/g,' ')));
  const csv = rows.map(r=> r.map(cell=>`"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`rekap_${new Date().toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(url);
}

/* ========== Orchestrator ========== */
async function initialize(){
  makeMonthOptions(); makeYearOptions();
  showSpinner('Menginisialisasi...');
  const cache = await fetchAll();
  hideSpinner();
  // always populate selects even if fetch failed
  populatePTs();
  populatePangkalanForSelectedPT();
  // initial render
  const rows = filterCachedRekap();
  const totals = renderTableAndSummary(rows);
  updateInfoBoxesFromCache(totals);
}

/* ========== Events ========== */
// When user changes PT/pangkalan/month/year, re-render from cache
document.getElementById('select-pt').addEventListener('change', ()=>{
  populatePangkalanForSelectedPT();
  const rows = filterCachedRekap(); const totals = renderTableAndSummary(rows); updateInfoBoxesFromCache(totals);
});
document.getElementById('select-pangkalan').addEventListener('change', ()=>{ const rows=filterCachedRekap(); const totals=renderTableAndSummary(rows); updateInfoBoxesFromCache(totals); });
document.getElementById('select-month').addEventListener('change', ()=>{ const rows=filterCachedRekap(); const totals=renderTableAndSummary(rows); updateInfoBoxesFromCache(totals); });
document.getElementById('select-year').addEventListener('change', ()=>{ const rows=filterCachedRekap(); const totals=renderTableAndSummary(rows); updateInfoBoxesFromCache(totals); });

// Main button: if cache empty, fetch first; else render from cache
document.getElementById('btn-load').addEventListener('click', async ()=>{
  try {
    if (!APP_CACHE.rekap || !APP_CACHE.rekap.rows || APP_CACHE.rekap.rows.length === 0) {
      showSpinner('Mengambil rekap dari server...');
      await fetchAll({}); // refresh minimal data
      populatePTs();
      populatePangkalanForSelectedPT();
      hideSpinner();
    }
    const rows = filterCachedRekap();
    const totals = renderTableAndSummary(rows);
    updateInfoBoxesFromCache(totals);
  } catch(e){
    console.error('btn-load error', e);
    alert('Gagal tampilkan rekap: ' + (e.message||e));
  }
});

// Refresh button: force refetch
document.getElementById('btn-refresh').addEventListener('click', async ()=>{
  showSpinner('Refresh data dari server...');
  await fetchAll();
  populatePTs();
  populatePangkalanForSelectedPT();
  const rows = filterCachedRekap(); const totals = renderTableAndSummary(rows); updateInfoBoxesFromCache(totals);
  hideSpinner();
});

// other actions
document.getElementById('btn-export-csv').addEventListener('click', exportCSV);
// Note: PDF and WA handlers from earlier version still work if you kept them; attach if present
// document.getElementById('btn-export-pdf').addEventListener('click', exportPDF);
// document.getElementById('btn-share-wa').addEventListener('click', shareWA);

window.addEventListener('DOMContentLoaded', initialize);
</script>
</body>
</html>
