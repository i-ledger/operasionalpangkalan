<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Buku Besar - i-ledger</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-cyan-100 to-blue-200 min-h-screen p-2 sm:p-4">
  <div class="spinner fixed top-1/2 left-1/2 w-10 h-10 border-4 border-gray-200 border-t-blue-500 rounded-full animate-spin z-50" id="loadingSpinner"></div>
  <div class="notification hidden fixed top-10 left-1/2 transform -translate-x-1/2 bg-white border border-gray-300 px-6 py-4 rounded-xl shadow-lg z-50 text-sm text-gray-800" id="pdfNotif">
    Sedang menyiapkan file PDF... (<span id="pdfProgress">0</span>%)
  </div>

  <div class="flex flex-col sm:flex-row gap-4">
    <!-- Sidebar -->
    <aside class="bg-white rounded-xl shadow-md p-4 w-full sm:w-64">
     <a href="dashboard.html" class="w-full block text-center bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg mb-4 transition-all duration-200 shadow">Dashboard</a>
      <h3 class="text-lg font-semibold text-blue-600 mb-2">Daftar Pos</h3>
      <ul id="posList" class="space-y-2 text-blue-600"></ul>
    </aside>

    <!-- Main content -->
    <main class="flex-1 bg-white rounded-xl shadow-md p-4">
      <h2 class="text-2xl font-semibold text-gray-800 mb-4">Data Buku Besar - i-Ledger</h2>
      <div class="flex flex-wrap gap-3 items-end mb-4">
        <label class="flex flex-col text-sm text-gray-700">
          Mulai:
          <input type="date" id="startDate" class="border rounded-md px-2 py-1 mt-1" />
        </label>
        <label class="flex flex-col text-sm text-gray-700">
          Selesai:
          <input type="date" id="endDate" class="border rounded-md px-2 py-1 mt-1" />
        </label>
        <button class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold shadow" id="filterBtn">Filter</button>
        <button class="px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white font-semibold shadow" id="resetBtn">Reset</button>
        <button class="px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white font-semibold shadow" id="excelBtn">Excel</button>
        <button class="px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white font-semibold shadow" id="downloadExcelPerPosBtn">Excel per POS</button>
        <button class="px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white font-semibold shadow" id="pdfBtn">PDF</button>
      </div>

      <div class="overflow-auto rounded-xl border border-gray-200">
        <table id="ledgerTable" class="min-w-[900px] w-full text-sm text-left text-gray-700">
          <thead class="bg-blue-600 text-white">
            <tr>
              <th class="p-3">Timestamp</th>
              <th class="p-3">Nama</th>
              <th class="p-3">Uraian</th>
              <th class="p-3">Pos</th>
              <th class="p-3">Nominal</th>
              <th class="p-3">Foto Nota</th>
              <th class="p-3">Pembayaran</th>
              <th class="p-3">Bukti Transfer</th>
              <th class="p-3">Aksi</th>
            </tr>
          </thead>
          <tbody id="ledgerTableBody" class="bg-white"></tbody>
        </table>
        <div id="totalNominal" class="font-semibold text-right p-4 text-blue-600">Total Nominal: Rp 0</div>
      </div>
    </main>
  </div>

  <!-- Modal Edit -->
  <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md">
      <h3 class="text-lg font-semibold mb-4">Edit Transaksi</h3>
      <form id="editForm" class="space-y-3">
        <input type="hidden" id="editTimestamp" />
        <label class="block">
          <span class="text-sm">Nama</span>
          <input type="text" id="editNama" class="w-full border rounded px-2 py-1" />
        </label>
        <label class="block">
          <span class="text-sm">Uraian</span>
          <input type="text" id="editUraian" class="w-full border rounded px-2 py-1" />
        </label>
        <label class="block">
          <span class="text-sm">Pos</span>
          <input type="text" id="editPos" class="w-full border rounded px-2 py-1" />
        </label>
        <label class="block">
          <span class="text-sm">Nominal</span>
          <input type="number" id="editNominal" class="w-full border rounded px-2 py-1" />
        </label>
        <label class="block">
          <span class="text-sm">Pembayaran</span>
          <select id="editPembayaran" class="w-full border rounded px-2 py-1">
            <option value="Cash">Cash</option>
            <option value="Transfer">Transfer</option>
          </select>
        </label>
        <div class="flex justify-end gap-2 mt-4">
          <button type="button" onclick="closeEditModal()" class="px-4 py-2 rounded bg-gray-400 hover:bg-gray-500 text-white">Batal</button>
          <button type="submit" class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white">Simpan</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="config.js"></script>
  <style>
    #ledgerTable td img {
      max-width: 50px;
      max-height: 50px;
      border-radius: 0.5rem;
      border: 1px solid #ddd;
      padding: 2px;
      background: #fff;
    }
    .pos-active {
      background-color: #2563eb !important;
      color: white !important;
      font-weight: bold;
      border-radius: 0.5rem;
      padding: 0.25rem 0.5rem;
    }
    #posList li {
      cursor: pointer;
      padding: 6px 12px;
      border-radius: 0.5rem;
      transition: background-color 0.2s;
    }
    #posList li:hover {
      background-color: #ebf4ff;
    }
  </style>

  <script>
    let allData = [];
    let allPos = [];

    if (localStorage.getItem('loggedIn') !== 'true') {
      window.location.href = 'login.html';
    }

    const id_spreadsheet = localStorage.getItem("id_spreadsheet");
    if (!id_spreadsheet) {
      alert("Spreadsheet ID tidak ditemukan. Silakan login ulang.");
      window.location.href = "login.html";
    }

    const endpoint = `${API_ENDPOINT}?action=transaksi&id_spreadsheet=${id_spreadsheet}`;
    const posEndpoint = `${API_ENDPOINT}?action=namapos&id_spreadsheet=${id_spreadsheet}`;

    function formatRupiah(angka) {
      const num = parseInt(angka.toString().replace(/[^\d]/g, ""));
      return isNaN(num) ? "" : num.toLocaleString("id-ID", { style: "currency", currency: "IDR" });
    }

    function formatTanggalIndonesia(datetimeStr) {
      const date = new Date(datetimeStr);
      if (isNaN(date)) return datetimeStr;
      const pad = n => n.toString().padStart(2, '0');
      return `${pad(date.getDate())}/${pad(date.getMonth() + 1)}/${date.getFullYear()} ${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
    }

    function extractDriveId(url) {
      if (!url) return null;
      let match = url.match(/\/d\/([a-zA-Z0-9_-]{10,})/);
      if (match) return match[1];
      match = url.match(/id=([a-zA-Z0-9_-]{10,})/);
      if (match) return match[1];
      return null;
    }

    async function fetchData() {
      document.getElementById("loadingSpinner").style.display = "block";
      try {
        const res = await fetch(endpoint);
        allData = await res.json();
        filterCurrentMonthData();
      } catch (error) {
        console.error(error);
      } finally {
        document.getElementById("loadingSpinner").style.display = "none";
      }
    }

    async function fetchPos() {
      const res = await fetch(posEndpoint);
      allPos = await res.json();
      renderPosList(allPos);
    }

    function renderPosList(posData) {
      const posList = document.getElementById("posList");
      posList.innerHTML = "";
      posData.forEach(pos => {
        const li = document.createElement("li");
        li.textContent = pos.nama_pos;
        li.onclick = () => filterByPos(pos.nama_pos);
        posList.appendChild(li);
      });
    }

    function renderTable(data) {
      const tbody = document.getElementById("ledgerTableBody");
      tbody.innerHTML = "";
      let totalNominal = 0;

      data.forEach(item => {
        const nominal = item.nominal ? parseInt(item.nominal) : 0;
        totalNominal += nominal;

        const fotoNota = item.foto && item.foto.includes('https://') 
          ? `<a href="${item.foto}" target="_blank"><img src="https://drive.google.com/thumbnail?id=${extractDriveId(item.foto)}&sz=w200" alt="Foto Nota" /></a>` 
          : '<span class="text-red-500">-</span>';

        const buktitransfer = item.buktitransfer && item.buktitransfer.includes('https://') 
          ? `<a href="${item.buktitransfer}" target="_blank"><img src="https://drive.google.com/thumbnail?id=${extractDriveId(item.buktitransfer)}&sz=w200" alt="Bukti Transfer" /></a>` 
          : '<span class="text-red-500">-</span>';

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${formatTanggalIndonesia(item.timestamp)}</td>
          <td>${item.nama || ""}</td>
          <td>${item.uraian || ""}</td>
          <td>${item.pos || ""}</td>
          <td>${nominal ? formatRupiah(nominal) : ""}</td>
          <td>${fotoNota}</td>
          <td>${item.pembayaran || ""}</td>
          <td>${buktitransfer}</td>
          <td><button class="px-2 py-1 bg-yellow-500 hover:bg-yellow-600 text-white rounded" onclick='openEditModal(${JSON.stringify(item)})'>✏️</button></td>
        `;
        tbody.appendChild(row);
      });

      document.getElementById("totalNominal").textContent = `Total Nominal: ${formatRupiah(totalNominal)}`;
    }

    function filterByPos(pos) {
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;
      let filteredData = allData;

      if (startDate && endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        end.setHours(23, 59, 59, 999);
        filteredData = filteredData.filter(item => {
          const t = new Date(item.timestamp);
          return t >= start && t <= end;
        });
      }

      if (pos) {
        filteredData = filteredData.filter(item => item.pos === pos);
      }

      renderTable(filteredData);
    }

    function filterByDate() {
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;
      if (!startDate || !endDate) {
        renderTable(allData);
        return;
      }
      const start = new Date(startDate);
      const end = new Date(endDate);
      end.setHours(23, 59, 59, 999);
      const filtered = allData.filter(item => {
        const t = new Date(item.timestamp);
        return t >= start && t <= end;
      });
      renderTable(filtered);
    }

    function filterCurrentMonthData() {
      const now = new Date();
      const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
      const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      lastDay.setHours(23, 59, 59, 999);
      const filtered = allData.filter(item => {
        const t = new Date(item.timestamp);
        return t >= firstDay && t <= lastDay;
      });
      renderTable(filtered);
    }

    function resetFilter() {
      document.getElementById("startDate").value = "";
      document.getElementById("endDate").value = "";
      renderTable(allData);
    }

    document.getElementById("filterBtn").addEventListener("click", filterByDate);
    document.getElementById("resetBtn").addEventListener("click", resetFilter);

    fetchData();
    fetchPos();
  </script>
</body>
</html>
