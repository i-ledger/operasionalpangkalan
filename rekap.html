<script>
function toggleMenu(){ document.getElementById("share-menu").classList.toggle("hidden"); }
function goDashboard(){ window.location.href="dashboard.html"; }

function formatRupiah(val){
  if(val==null || val==='' || Number(val)===0) return '-';
  const num = Number(val);
  let text = 'Rp ' + num.toLocaleString('id-ID');
  if(num < 0) return `<span class="text-red-600 font-semibold">${text}</span>`;
  if(num > 0) return `<span class="text-green-600 font-semibold">${text}</span>`;
  return '';
}

const GAS_URL = 'https://script.google.com/macros/s/AKfycbxlbV03f3Rap-egwwdYYObqGju0pYNXsRa6tKisBpxurrvZkAsBMORdHKb8yQPPXRIKlw/exec';
const SPINNER = document.getElementById('spinner');
function showSpinner(){ SPINNER.classList.remove('hidden'); }
function hideSpinner(){ SPINNER.classList.add('hidden'); }

// === CACHE GLOBAL ===
const CACHE = {
  pts: null,
  pangkalan: {}, // key = PT, value = array pangkalan
  rekap: {},     // key = `${pt}_${bulan}_${tahun}`, value = data rekap
  doinfo: {}     // key = `${pt}_${pangkalan}`, value = info DO
};

async function fetchJSON(url){
  try{ showSpinner(); const res = await fetch(url); return await res.json(); }
  catch(e){ console.error(e); alert('Gagal mengambil data'); return null; }
  finally{ hideSpinner(); }
}

function makeMonthOptions(){
  const sel = document.getElementById('select-month');
  const months = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
  const now = new Date();
  months.forEach((m,i)=>{ 
    const opt = document.createElement('option'); 
    opt.value = i+1; opt.textContent = m; 
    if(i===now.getMonth()) opt.selected = true; 
    sel.appendChild(opt) 
  });
}
function makeYearOptions(){
  const sel = document.getElementById('select-year');
  const yearNow = new Date().getFullYear();
  for(let y=yearNow-2;y<=yearNow+1;y++){ 
    const opt=document.createElement('option'); 
    opt.value=y; opt.textContent=y; 
    if(y===yearNow) opt.selected = true; 
    sel.appendChild(opt);
  }
}

async function loadPTs(){
  if(CACHE.pts){ renderPTs(CACHE.pts); return; }
  const url = `${GAS_URL}?action=getPTs`; 
  const data = await fetchJSON(url); 
  if(!data) return;
  CACHE.pts = data;
  renderPTs(data);
}

function renderPTs(data){
  const sel = document.getElementById('select-pt');
  sel.innerHTML = '';
  data.forEach(pt=>{ const o=document.createElement('option'); o.value=pt; o.textContent=pt; sel.appendChild(o) });
  sel.dispatchEvent(new Event('change'));
}

async function loadPangkalanForPT(pt){
  if(CACHE.pangkalan[pt]){ renderPangkalan(CACHE.pangkalan[pt]); return; }
  const url = `${GAS_URL}?action=getPangkalan&pt=${encodeURIComponent(pt)}`;
  const data = await fetchJSON(url); 
  CACHE.pangkalan[pt] = data || [];
  renderPangkalan(CACHE.pangkalan[pt]);
}

function renderPangkalan(data){
  const sel = document.getElementById('select-pangkalan');
  sel.innerHTML='';
  const empty = document.createElement('option'); empty.value='ALL'; empty.textContent='-- Semua Pangkalan --'; empty.selected = true; sel.appendChild(empty);
  (data||[]).forEach(r=>{ const o=document.createElement('option'); o.value=r; o.textContent=r; sel.appendChild(o); });
}

function getSelectedPangkalan(){
  const sel = document.getElementById('select-pangkalan');
  const vals = Array.from(sel.selectedOptions).map(o=>o.value);
  if (vals.length === 0) return ['ALL'];
  if (vals.includes('ALL')) return ['ALL'];
  return vals;
}

// Info DO
async function updateDOInfo(pt, pangkalanList){
  const key = `${pt}_${pangkalanList.join(',')}`;
  if(CACHE.doinfo[key]){ renderDOInfo(CACHE.doinfo[key]); return; }

  const q = pangkalanList.join(',');
  const url = `${GAS_URL}?action=getDOInfo&pt=${encodeURIComponent(pt)}&pangkalan=${encodeURIComponent(q)}`;
  const d = await fetchJSON(url);
  if(!d) return;
  CACHE.doinfo[key] = d;
  renderDOInfo(d);
}
function renderDOInfo(d){
  document.getElementById('do-owned').textContent = d.do_owned ?? '-';
  document.getElementById('price').innerHTML = d.harga_tabung ? formatRupiah(d.harga_tabung) : '-';
  document.getElementById('harga-bagi-hasil').innerHTML = d.harga_bagi_hasil ? formatRupiah(d.harga_bagi_hasil) : '-';
  document.getElementById('total-penerimaan').textContent = d.total_penerimaan ?? '-';
}

async function loadRekap(){
  const pt = document.getElementById('select-pt').value;
  const pangkalans = getSelectedPangkalan();
  const month = document.getElementById('select-month').value;
  const year = document.getElementById('select-year').value;
  const key = `${pt}_${month}_${year}_${pangkalans.join(',')}`;

  await updateDOInfo(pt, pangkalans);

  if(CACHE.rekap[key]){
    renderRekap(CACHE.rekap[key]);
    return;
  }

  const url = `${GAS_URL}?action=getRekap&pt=${encodeURIComponent(pt)}&pangkalan=${encodeURIComponent(pangkalans.join(','))}&month=${month}&year=${year}`;
  const data = await fetchJSON(url);
  if(!data) return;
  CACHE.rekap[key] = data;
  renderRekap(data);
}

function renderRekap(data){
  const totals = renderTable(data.rows);
  document.getElementById('total-penerimaan').textContent = data.total_penerimaan ?? '-';
  document.getElementById('do-owned').textContent = data.do_owned ?? '-';
  document.getElementById('price').innerHTML = data.harga_tabung ? formatRupiah(data.harga_tabung) : '-';
  document.getElementById('harga-bagi-hasil').innerHTML = data.harga_bagi_hasil ? formatRupiah(data.harga_bagi_hasil) : '-';
  hitungTabungKerjasama({...data, totalBagiHasil: totals.totalBagiHasil});
}
