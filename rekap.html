<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rekap Operasional ‚Äî i-Shipping</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Striping tabel biar ringan */
    #rekap-table tbody tr:nth-child(even){ background:#f9fafb; }
    #rekap-table tbody tr:nth-child(odd){ background:#fff; }
    #rekap-table th, #rekap-table td { white-space:nowrap; }
  </style>
</head>
<body class="bg-blue-50 min-h-screen p-4 font-sans">
  <div class="max-w-5xl mx-auto">

    <!-- Header -->
    <header class="flex items-center justify-between mb-4 bg-blue-200 p-3 rounded-lg shadow">
      <h1 class="text-xl font-bold text-blue-900">üìä Rekap Operasional</h1>
      <div class="flex items-center gap-2">
        <button onclick="goDashboard()" class="px-3 py-1 bg-blue-600 text-white text-sm rounded-lg shadow hover:bg-blue-700">üè† Dashboard</button>
        <div id="spinner" class="hidden fixed inset-0 bg-black bg-opacity-40 flex flex-col items-center justify-center z-50">
          <svg class="animate-spin h-12 w-12 text-blue-400 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
          </svg>
          <span class="text-white text-lg font-semibold">Loading...</span>
        </div>
      </div>
    </header>

    <!-- Filter Section -->
    <section class="bg-white p-4 rounded-xl shadow mb-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-medium text-blue-900">Nama PT</label>
          <select id="select-pt" class="mt-1 block w-full rounded-md border-gray-300"></select>
        </div>
        <div>
          <label class="block text-sm font-medium text-blue-900">Nama Pangkalan</label>
          <select id="select-pangkalan" multiple size="5" class="mt-1 block w-full rounded-md border-gray-300"></select>
        </div>
        <div>
          <label class="block text-sm font-medium text-blue-900">Bulan</label>
          <select id="select-month" class="mt-1 block w-full rounded-md border-gray-300"></select>
        </div>
        <div>
          <label class="block text-sm font-medium text-blue-900">Tahun</label>
          <select id="select-year" class="mt-1 block w-full rounded-md border-gray-300"></select>
        </div>
      </div>

      <!-- Info Box -->
      <div class="mt-4 grid grid-cols-2 md:grid-cols-6 gap-4 text-center">
        <div class="bg-blue-100 p-3 rounded-lg shadow">
          <div class="text-xs text-gray-600">DO yang dimiliki</div>
          <div id="do-owned" class="text-lg font-semibold">-</div>
        </div>
        <div class="bg-blue-100 p-3 rounded-lg shadow">
          <div class="text-xs text-gray-600">Harga Tabung</div>
          <div id="price" class="text-lg font-semibold">-</div>
        </div>
        <div class="bg-blue-100 p-3 rounded-lg shadow">
          <div class="text-xs text-gray-600">Harga Bagi Hasil</div>
          <div id="harga-bagi-hasil" class="text-lg font-semibold">-</div>
        </div>
        <div class="bg-blue-100 p-3 rounded-lg shadow">
          <div class="text-xs text-gray-600">Total Penerimaan</div>
          <div id="total-penerimaan" class="text-lg font-semibold">-</div>
        </div>
        <div class="bg-blue-100 p-3 rounded-lg shadow">
          <div class="text-xs text-gray-600">Tabung Kerjasama</div>
          <div id="tabung-kerjasama" class="text-lg font-semibold">-</div>
        </div>
        <div class="bg-blue-100 p-3 rounded-lg shadow">
          <div class="text-xs text-gray-600">Sisa Bagi Hasil</div>
          <div id="sisa-bagi-hasil" class="text-lg font-semibold">-</div>
        </div>
      </div>

      <div class="mt-4 flex flex-wrap gap-2">
        <button id="btn-load" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700">üîé Tampilkan Rekap</button>
        <button id="btn-export-csv" class="px-4 py-2 border border-blue-400 text-blue-700 rounded-lg shadow">üì• Export CSV</button>
        
        <!-- Dropdown Bagikan -->
        <div class="relative inline-block text-left">
          <button onclick="toggleMenu()" class="px-4 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700">
            üì§ Bagikan
          </button>
          <div id="share-menu" class="hidden absolute mt-2 w-48 bg-white border rounded-lg shadow-lg z-50">
            <button onclick="shareRekapWA()" class="w-full text-left px-4 py-2 hover:bg-gray-100">üì± WhatsApp</button>
            <button onclick="downloadPDF()" class="w-full text-left px-4 py-2 hover:bg-gray-100">üìÑ Download PDF</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Table Wrapper -->
    <section id="rekap-wrapper" class="bg-white p-4 rounded-xl shadow">
      <div class="overflow-auto">
        <table id="rekap-table" class="min-w-full border border-gray-300">
          <thead class="bg-blue-200 text-blue-900 font-bold">
            <tr>
              <th class="px-3 py-2 border">Tanggal</th>
              <th class="px-3 py-2 border">Laporan Driver</th>
              <th class="px-3 py-2 border">Retur</th>
              <th class="px-3 py-2 border">Dikirim</th>
              <th class="px-3 py-2 border">SA Pangkalan</th>
              <th class="px-3 py-2 border">Pengiriman</th>
              <th class="px-3 py-2 border">Nominal Dibayar</th>
              <th class="px-3 py-2 border">Brimola Oleh</th>
              <th class="px-3 py-2 border">Bayar Brimola</th>
              <th class="px-3 py-2 border">Bukti TF</th>
              <th class="px-3 py-2 border">Bagi Hasil</th>
              <th class="px-3 py-2 border text-blue-900">Total TBG</th>
            </tr>
          </thead>
          <tbody id="rekap-body" class="bg-white"></tbody>
          <tfoot class="bg-blue-100 font-semibold">
            <tr>
              <td colspan="5" class="px-3 py-2 text-right border">TOTAL</td>
              <td id="total-pengiriman" class="px-3 py-2 border text-right whitespace-nowrap">0</td>
              <td></td><td></td><td></td><td></td>
              <td id="total-bagi-hasil" class="px-3 py-2 border text-right whitespace-nowrap">0</td>
              <td id="grand-total" class="px-3 py-2 border text-right whitespace-nowrap text-blue-800">0</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>
  </div>

<script>
function toggleMenu(){ document.getElementById("share-menu").classList.toggle("hidden"); }
function goDashboard(){ window.location.href="dashboard.html"; }

function formatRupiah(val){
  if(val==null || val==='' || Number(val)===0) return '-';
  const num = Number(val);
  let text = 'Rp ' + num.toLocaleString('id-ID');
  if(num < 0) return `<span class="text-red-600 font-semibold">${text}</span>`;
  if(num > 0) return `<span class="text-green-600 font-semibold">${text}</span>`;
  return '';
}

const GAS_URL = 'https://script.google.com/macros/s/AKfycbzqkQmHeoF6Wc8i1mn-BBntaJaqgmMShLCnhdtcM9gwHr6bj80LUgYUAF43QMcLiFXxyA/exec';
const SPINNER = document.getElementById('spinner');
function showSpinner(){ SPINNER.classList.remove('hidden'); }
function hideSpinner(){ SPINNER.classList.add('hidden'); }

/* ---- tiny fetch wrapper ---- */
async function fetchJSON(url){
  try{ showSpinner(); const res = await fetch(url); return await res.json(); }
  catch(e){ console.error(e); alert('Gagal mengambil data'); return null; }
  finally{ hideSpinner(); }
}

/* ---- UI helpers (month/year dropdowns) ---- */
function makeMonthOptions(){
  const sel = document.getElementById('select-month');
  sel.innerHTML = '';
  const months = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
  const now = new Date();
  months.forEach((m,i)=>{ 
    const opt = document.createElement('option'); 
    opt.value = i+1; opt.textContent = m; 
    if(i===now.getMonth()) opt.selected = true; 
    sel.appendChild(opt);
  });
}
function makeYearOptions(){
  const sel = document.getElementById('select-year');
  sel.innerHTML = '';
  const yearNow = new Date().getFullYear();
  for(let y=yearNow-2;y<=yearNow+1;y++){ 
    const opt=document.createElement('option'); 
    opt.value=y; opt.textContent=y; 
    if(y===yearNow) opt.selected = true; 
    sel.appendChild(opt);
  }
}

/* ---- PT & Pangkalan loaders (tetap sama) ---- */
async function loadPTs(){
  const url = `${GAS_URL}?action=getPTs`; 
  const data = await fetchJSON(url); if(!data) return;
  const sel = document.getElementById('select-pt');
  sel.innerHTML = '';
  data.forEach(pt=>{ const o=document.createElement('option'); o.value=pt; o.textContent=pt; sel.appendChild(o) });
  // trigger load pangkalan untuk first PT
  sel.dispatchEvent(new Event('change'));
}

async function loadPangkalanForPT(pt){
  const url = `${GAS_URL}?action=getPangkalan&pt=${encodeURIComponent(pt)}`;
  const data = await fetchJSON(url); 
  const sel = document.getElementById('select-pangkalan');
  sel.innerHTML='';
  const empty = document.createElement('option'); empty.value='ALL'; empty.textContent='-- Semua Pangkalan --'; empty.selected = true; sel.appendChild(empty);
  (data||[]).forEach(r=>{ const o=document.createElement('option'); o.value=r; o.textContent=r; sel.appendChild(o); });
}

/* ---- selected pangkalan helper ---- */
function getSelectedPangkalan(){
  const sel = document.getElementById('select-pangkalan');
  const vals = Array.from(sel.selectedOptions).map(o=>o.value);
  if (vals.length === 0) return ['ALL'];
  if (vals.includes('ALL')) return ['ALL'];
  return vals;
}

/* ---- cache: key = pt|pangkalanComma|month|year ---- */
const dataCache = new Map();

/* ---- Normalize backend responses into expected row shape ----
   We keep the UI's field names (laporan_pengiriman, master_sa, nominal_harus_dibayar, bukti_transfer, etc.)
   but accept multiple backend key variants.
*/
function normalizeRow(r){
  // backend may use different keys depending on version; map conservatively
  const get = (a,b,c,def)=> (r[a] !== undefined ? r[a] : (r[b] !== undefined ? r[b] : (r[c] !== undefined ? r[c] : def)));

  const row = {
    tanggal: get('tanggal','tgl','date',''),
    laporan_pengiriman: get('laporan_pengiriman','laporan','laporan_driver',0),
    retur: Number(get('retur','Retur',null,0)) || 0,
    dikirim: get('dikirim','drivers','driver',''),
    master_sa: Number(get('master_sa','saPengiriman','sa_pengiriman',0)) || 0,
    pengiriman: Number(get('pengiriman','pengiriman_total','jumlah_pengiriman',0)) || 0,
    nominal_harus_dibayar: Number(get('nominal_harus_dibayar','totalTagihan','total_tagihan',0)) || 0,
    brimola_oleh: get('brimola_oleh','brimolaOleh','oleh',''),
    bayar_lewat_brimola: Number(get('bayar_lewat_brimola','bayarBrimola','nominal_brimola',0)) || 0,
    bukti_transfer: Number(get('bukti_transfer','bukti_tf','nominal_bukti',0)) || 0,
    bagi_hasil: Number(get('bagi_hasil','bagiHasil','bagi_hasil',0)) || 0
  };

  // ensure tanggal format dd/MM/yyyy - if it's yyyy-mm-dd input, convert
  if (row.tanggal && /^\d{4}-\d{2}-\d{2}$/.test(row.tanggal)) {
    const parts = row.tanggal.split('-'); row.tanggal = `${parts[2]}/${parts[1]}/${parts[0]}`;
  }
  return row;
}

/* ---- update DO info UI: prefer data provided by backend (if any) ---- */
function fillDOInfoFromResponse(resp){
  // resp might be { total_penerimaan, do_owned, harga_tabung, harga_bagi_hasil } or nested
  if (!resp) return;
  const maybe = (k)=> (resp[k] !== undefined ? resp[k] : (resp.rekapMeta && resp.rekapMeta[k] !== undefined ? resp.rekapMeta[k] : null));
  const do_owned = maybe('do_owned') ?? maybe('doOwned') ?? null;
  const harga_tabung = maybe('harga_tabung') ?? maybe('hargaTbg') ?? null;
  const harga_bagi_hasil = maybe('harga_bagi_hasil') ?? maybe('harga_bagi') ?? null;
  const total_penerimaan = maybe('total_penerimaan') ?? maybe('totalPenerimaan') ?? null;

  if (do_owned !== null) document.getElementById('do-owned').textContent = do_owned ?? '-';
  if (harga_tabung !== null) document.getElementById('price').innerHTML = harga_tabung ? formatRupiah(harga_tabung) : '-';
  if (harga_bagi_hasil !== null) document.getElementById('harga-bagi-hasil').innerHTML = harga_bagi_hasil ? formatRupiah(harga_bagi_hasil) : '-';
  if (total_penerimaan !== null) document.getElementById('total-penerimaan').textContent = total_penerimaan ?? '-';
}

/* ---- Main: loadRekap (uses cache) ---- */
async function loadRekap(){
  const pt = document.getElementById('select-pt').value || 'ALL';
  const pangkalans = getSelectedPangkalan();
  const month = document.getElementById('select-month').value;
  const year = document.getElementById('select-year').value;

  // cache key
  const cacheKey = `${pt}|${pangkalans.join(',')}|${month}|${year}`;
  // if cached, use it
  if (dataCache.has(cacheKey)) {
    const cached = dataCache.get(cacheKey);
    // fill DO info if present
    fillDOInfoFromResponse(cached.meta);
    const rows = (cached.rows||[]).map(normalizeRow);
    const totals = renderTable(rows);
    hitungTabungKerjasama({...cached.meta, totalBagiHasil: totals.totalBagiHasil});
    return;
  }

  // not cached -> fetch
  await updateDOInfo(pt, pangkalans); // try to update DO info quickly (may be missing)
  const url = `${GAS_URL}?action=getRekap&pt=${encodeURIComponent(pt)}&pangkalan=${encodeURIComponent(pangkalans.join(','))}&month=${month}&year=${year}`;
  const raw = await fetchJSON(url);
  if (!raw) return;

  // backend may respond in different shapes:
  // - { rows: [...], total_penerimaan:..., do_owned:..., harga_tabung:... }
  // - { rekap: [...] } (getAllData style)
  // - array [...]
  let rowsArray = [];
  let meta = {};
  if (Array.isArray(raw)) {
    rowsArray = raw;
  } else if (raw.rows) {
    rowsArray = raw.rows;
    meta = Object.assign({}, raw);
    delete meta.rows;
  } else if (raw.rekap) {
    rowsArray = raw.rekap;
    meta = Object.assign({}, raw);
    delete meta.rekap;
  } else if (raw.rekap && Array.isArray(raw.rekap)) {
    rowsArray = raw.rekap;
  } else {
    // fallback: try to find array inside response
    for (const k in raw) {
      if (Array.isArray(raw[k])) { rowsArray = raw[k]; break; }
    }
  }

  // normalize rows
  const rows = rowsArray.map(normalizeRow);

  // cache meta + rows
  dataCache.set(cacheKey, { rows: rowsArray, meta });

  // fill UI DO info from meta if available
  fillDOInfoFromResponse(meta);

  // render
  const totals = renderTable(rows);
  // compute tabung kerjasama based on meta + totals
  hitungTabungKerjasama({...meta, totalBagiHasil: totals.totalBagiHasil});
}

/* ---- renderTable expects rows already normalized ---- */
function renderTable(rows){
  const tbody = document.getElementById('rekap-body');
  tbody.innerHTML='';
  let grandTotal = 0, totalPengiriman=0, totalBagiHasil=0;

  rows.forEach(r=>{
    const bayarBrimola = Number(r.bayar_lewat_brimola) || 0;
    const nominalHarusDibayar = Number(r.nominal_harus_dibayar) || 0;
    const buktiTransfer = Number(r.bukti_transfer) || 0;
    const pengiriman = Number(r.pengiriman) || 0;
    const bagiHasil = Number(r.bagi_hasil) || 0;
    const totalTBG = bayarBrimola - nominalHarusDibayar + buktiTransfer;

    grandTotal += totalTBG;
    totalPengiriman += pengiriman;
    totalBagiHasil += bagiHasil;

    const tr = document.createElement('tr'); 
    tr.innerHTML = `
      <td class="px-3 py-2 text-sm">${r.tanggal}</td>
      <td class="px-3 py-2 text-sm">${r.laporan_pengiriman ?? '-'}</td>
      <td class="px-3 py-2 text-sm">${r.retur ?? 0}</td>
      <td class="px-3 py-2 text-sm">${r.dikirim ?? ''}</td>
      <td class="px-3 py-2 text-sm">${r.master_sa ?? 0}</td>
      <td class="px-3 py-2 text-sm text-right">${pengiriman}</td>
      <td class="px-3 py-2 text-sm text-right">${formatRupiah(r.nominal_harus_dibayar)}</td>
      <td class="px-3 py-2 text-sm">${r.brimola_oleh ?? ''}</td>
      <td class="px-3 py-2 text-sm text-right">${formatRupiah(r.bayar_lewat_brimola)}</td>
      <td class="px-3 py-2 text-sm text-right">${formatRupiah(r.bukti_transfer)}</td>
      <td class="px-3 py-2 text-sm text-right">${formatRupiah(r.bagi_hasil)}</td>
      <td class="px-3 py-2 text-sm text-right text-blue-600 font-semibold">${formatRupiah(totalTBG)}</td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById('total-pengiriman').textContent = totalPengiriman;
  document.getElementById('total-bagi-hasil').innerHTML = formatRupiah(totalBagiHasil);
  document.getElementById('grand-total').innerHTML = formatRupiah(grandTotal);

  return { totalPengiriman, totalBagiHasil, grandTotal };
}

/* ---- hitung Tabung Kerjasama (menggunakan meta jika tersedia) ---- */
function hitungTabungKerjasama(data){
  const tP = Number(data.total_penerimaan)||0;
  const dO = Number(data.do_owned)||0;
  const hrgBagi = Number(data.harga_bagi_hasil)||0;
  const sudahBayar = Number(data.totalBagiHasil)||0;

  const tabungKerjasama = (tP - dO);
  const nominalBagiHasil = tabungKerjasama * hrgBagi;
  const sisa = nominalBagiHasil - sudahBayar;

  document.getElementById('tabung-kerjasama').textContent = (tabungKerjasama ? tabungKerjasama + ' Tbg' : '-');
  document.getElementById('sisa-bagi-hasil').innerHTML = sisa ? formatRupiah(sisa) : '-';
}

/* ---- Export CSV (pakai isi tabel saat ini) ---- */
document.getElementById('btn-export-csv').addEventListener('click', ()=>{
  const rows = Array.from(document.querySelectorAll('#rekap-table tr')).map(tr=> 
    Array.from(tr.querySelectorAll('th,td')).map(td=> td.innerText.replace(/\n/g,' '))
  );
  let csv = rows.map(r=>r.join(',')).join('\n');
  let blob = new Blob([csv], {type:'text/csv'});
  let url = URL.createObjectURL(blob);
  let a=document.createElement('a'); a.href=url; a.download='rekap.csv'; a.click();
  URL.revokeObjectURL(url);
});

/* ---- Lazy load libs helper ---- */
async function loadLib(url){
  if(!document.querySelector(`script[src="${url}"]`)){
    return new Promise(resolve=>{
      const s=document.createElement("script");
      s.src=url; s.onload=resolve; document.body.appendChild(s);
    });
  }
}

/* ---- Share via WA (screenshot) ---- */
async function shareRekapWA(){
  await loadLib("https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js");
  const wrapper=document.getElementById("rekap-wrapper");
  const canvas=await html2canvas(wrapper,{scale:1});
  const dataUrl=canvas.toDataURL("image/png");
  const blob=await (await fetch(dataUrl)).blob();
  const file=new File([blob],"rekap.png",{type:"image/png"});
  if(navigator.canShare && navigator.canShare({files:[file]})){
    await navigator.share({files:[file],title:"Rekap Operasional"});
  } else {
    alert("Browser tidak mendukung Web Share API untuk file.");
  }
}

/* ---- Download PDF (screenshot) ---- */
async function downloadPDF(){
  await loadLib("https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js");
  await loadLib("https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js");
  const { jsPDF }=window.jspdf;
  const wrapper=document.getElementById("rekap-wrapper");
  const canvas=await html2canvas(wrapper,{scale:1});
  const imgData=canvas.toDataURL("image/png");
  const pdf=new jsPDF("l","pt","a4");
  const pageW=pdf.internal.pageSize.getWidth();
  const imgW=pageW-40;
  const imgH=canvas.height*imgW/canvas.width;
  pdf.addImage(imgData,"PNG",20,20,imgW,imgH);
  pdf.save("rekap.pdf");
}

/* ---- Init ---- */
window.addEventListener('DOMContentLoaded',()=>{
  makeMonthOptions();
  makeYearOptions();
  loadPTs();
  document.getElementById('select-pt').addEventListener('change',e=> loadPangkalanForPT(e.target.value));
  document.getElementById('btn-load').addEventListener('click', loadRekap);
});
</script>

</body>
</html>
