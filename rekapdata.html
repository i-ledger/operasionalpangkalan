<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rekap Operasional</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen p-4">

  <h1 class="text-xl font-bold mb-4">Rekap Operasional</h1>

  <!-- Dashboard Atas -->
  <div class="mt-4 grid grid-cols-1 md:grid-cols-4 gap-4">
    <div class="bg-slate-100 p-3 rounded">
      <div class="text-xs text-gray-500">DO yang dimiliki (total)</div>
      <div id="do-owned" class="text-lg font-medium">-</div>
    </div>
    <div class="bg-slate-100 p-3 rounded">
      <div class="text-xs text-gray-500">Harga Bagi Hasil</div>
      <div id="price" class="text-lg font-medium">-</div>
      <div class="text-[11px] text-gray-500">Jika multi harga: ditampilkan “-”</div>
    </div>
    <div class="bg-slate-100 p-3 rounded">
      <div class="text-xs text-gray-500">Total Penerimaan TBG Bulanan</div>
      <div id="total-penerimaan" class="text-lg font-medium">-</div>
    </div>
  </div>

  <!-- Kotak Baru -->
  <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
    <div class="bg-slate-100 p-3 rounded">
      <div class="text-xs text-gray-500">Tabung Kerjasama</div>
      <div id="tabung-kerjasama" class="text-lg font-medium">-</div>
    </div>
    <div class="bg-slate-100 p-3 rounded">
      <div class="text-xs text-gray-500">Dikurangi Total Bagi Hasil yang Sudah Dibayar</div>
      <div id="sisa-bagi-hasil" class="text-lg font-medium text-red-600">-</div>
    </div>
  </div>

  <!-- Rekap Tabel -->
  <div class="mt-6">
    <table class="w-full border text-sm bg-white shadow rounded">
      <thead class="bg-gray-200">
        <tr>
          <th class="border px-2 py-1">Tanggal</th>
          <th class="border px-2 py-1">Nama PT</th>
          <th class="border px-2 py-1">Nama Pangkalan</th>
          <th class="border px-2 py-1">Jumlah Tabung</th>
          <th class="border px-2 py-1">Bagi Hasil Dibayar</th>
        </tr>
      </thead>
      <tbody id="rekap-body">
        <tr><td colspan="5" class="text-center p-3 text-gray-500">Loading...</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    function formatRupiah(angka) {
      return new Intl.NumberFormat("id-ID", {
        style: "currency",
        currency: "IDR",
        minimumFractionDigits: 0
      }).format(angka);
    }

    function hitungTabungKerjasama(totalPenerimaan, doOwned, harga, totalBagiHasilBayar) {
      const tP = Number(totalPenerimaan) || 0;
      const dO = Number(doOwned) || 0;
      const hrg = Number(harga) || 0;
      const sudahBayar = Number(totalBagiHasilBayar) || 0;

      const tabungKerjasama = (tP - dO) * hrg;
      const sisa = tabungKerjasama - sudahBayar;

      document.getElementById('tabung-kerjasama').textContent = formatRupiah(tabungKerjasama);
      document.getElementById('sisa-bagi-hasil').textContent = formatRupiah(sisa);
    }

    async function loadRekap() {
      try {
        const res = await fetch("https://script.google.com/macros/s/AKfycbyrw10g_NvT_Ykq9R3yPm4M9SzYOXIx-YYSAGMWJirHeiWLK3EWEachjawcNiCDsnzZ/exec?action=getRekap");
        const data = await res.json();

        document.getElementById('do-owned').textContent = data.do_owned || "-";
        document.getElementById('price').textContent = data.price ? formatRupiah(data.price) : "-";
        document.getElementById('total-penerimaan').textContent = data.total_penerimaan || "-";

        // isi tabel
        const tbody = document.getElementById('rekap-body');
        tbody.innerHTML = "";
        data.rows.forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="border px-2 py-1">${r.tanggal}</td>
            <td class="border px-2 py-1">${r.pt}</td>
            <td class="border px-2 py-1">${r.pangkalan}</td>
            <td class="border px-2 py-1">${r.jumlah}</td>
            <td class="border px-2 py-1">${formatRupiah(r.bagi_hasil_bayar || 0)}</td>
          `;
          tbody.appendChild(tr);
        });

        // hitung tabung kerjasama & sisa
        hitungTabungKerjasama(
          data.total_penerimaan,
          data.do_owned,
          data.price,
          data.total_bagi_hasil_bayar
        );

      } catch (e) {
        console.error("Error:", e);
      }
    }

    loadRekap();
  </script>
</body>
</html>
