<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Rekap Data i-Shipping</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">
  <h1 class="text-2xl font-bold mb-4">Rekap Data i-Shipping</h1>

  <!-- Filter -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    <div>
      <label class="block mb-1">Pilih PT</label>
      <select id="pt-select" class="w-full p-2 border rounded"></select>
    </div>
    <div>
      <label class="block mb-1">Pilih Pangkalan</label>
      <select id="pangkalan-select" class="w-full p-2 border rounded"></select>
    </div>
    <div>
      <label class="block mb-1">Bulan</label>
      <input type="number" id="month" min="1" max="12" class="w-full p-2 border rounded">
    </div>
    <div>
      <label class="block mb-1">Tahun</label>
      <input type="number" id="year" min="2020" class="w-full p-2 border rounded">
    </div>
  </div>

  <button onclick="loadRekap()" class="bg-blue-600 text-white px-4 py-2 rounded">Tampilkan Rekap</button>

  <!-- Ringkasan -->
  <div class="mt-6 bg-white p-4 rounded shadow">
    <h2 class="text-xl font-semibold mb-3">Ringkasan</h2>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <div>
        <p class="font-semibold">DO Owned</p>
        <p id="do-owned">-</p>
      </div>
      <div>
        <p class="font-semibold">Harga Tabung</p>
        <p id="price">-</p>
      </div>
      <div>
        <p class="font-semibold">Harga Bagi Hasil</p>
        <p id="harga-bagi-hasil">-</p>
      </div>
      <div>
        <p class="font-semibold">Total Penerimaan</p>
        <p id="total-penerimaan">-</p>
      </div>
    </div>
  </div>

  <!-- Tabel Rekap -->
  <div class="mt-6 overflow-x-auto">
    <table class="min-w-full bg-white border">
      <thead class="bg-gray-200">
        <tr>
          <th class="border px-2 py-1">Tanggal</th>
          <th class="border px-2 py-1">Laporan Pengiriman</th>
          <th class="border px-2 py-1">Retur</th>
          <th class="border px-2 py-1">Dikirim</th>
          <th class="border px-2 py-1">Master SA</th>
          <th class="border px-2 py-1">Pengiriman</th>
          <th class="border px-2 py-1">Nominal Harus Dibayar</th>
          <th class="border px-2 py-1">Brimola Oleh</th>
          <th class="border px-2 py-1">Bayar Lewat Brimola</th>
          <th class="border px-2 py-1">Bukti Transfer</th>
          <th class="border px-2 py-1">Bagi Hasil</th>
        </tr>
      </thead>
      <tbody id="rekap-body"></tbody>
    </table>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyrw10g_NvT_Ykq9R3yPm4M9SzYOXIx-YYSAGMWJirHeiWLK3EWEachjawcNiCDsnzZ/exec";

    function formatRupiah(num) {
      if (!num || isNaN(num)) return '-';
      return "Rp " + Number(num).toLocaleString("id-ID");
    }

    async function loadPTs() {
      try {
        const res = await fetch(`${API_URL}?action=getPTs`);
        const data = await res.json();
        if (!Array.isArray(data)) throw new Error("PTs bukan array");

        const select = document.getElementById("pt-select");
        select.innerHTML = "<option value='ALL'>ALL</option>";
        data.forEach(pt => {
          const opt = document.createElement("option");
          opt.value = pt;
          opt.textContent = pt;
          select.appendChild(opt);
        });
      } catch (err) {
        console.error("Error load PTs:", err);
      }
    }

    async function loadPangkalan(pt) {
      try {
        const res = await fetch(`${API_URL}?action=getPangkalan&pt=${encodeURIComponent(pt)}`);
        const data = await res.json();
        if (!Array.isArray(data)) throw new Error("Pangkalan bukan array");

        const select = document.getElementById("pangkalan-select");
        select.innerHTML = "<option value='ALL'>ALL</option>";
        data.forEach(p => {
          const opt = document.createElement("option");
          opt.value = p;
          opt.textContent = p;
          select.appendChild(opt);
        });
      } catch (err) {
        console.error("Error load Pangkalan:", err);
      }
    }

    async function loadRekap() {
      const pt = document.getElementById("pt-select").value;
      const pangkalan = document.getElementById("pangkalan-select").value;
      const month = document.getElementById("month").value;
      const year = document.getElementById("year").value;

      try {
        const res = await fetch(`${API_URL}?action=getRekap&pt=${encodeURIComponent(pt)}&pangkalan=${encodeURIComponent(pangkalan)}&month=${month}&year=${year}`);
        const data = await res.json();

        // Update ringkasan
        document.getElementById('do-owned').textContent = data.do_owned ?? '-';
        document.getElementById('price').textContent = data.harga_tabung ? formatRupiah(data.harga_tabung) : '-';
        document.getElementById('harga-bagi-hasil').textContent = data.harga_bagi_hasil ? formatRupiah(data.harga_bagi_hasil) : '-';
        document.getElementById('total-penerimaan').textContent = data.total_penerimaan ? formatRupiah(data.total_penerimaan) : '-';

        // Tabel rekap
        const tbody = document.getElementById("rekap-body");
        tbody.innerHTML = "";
        data.rows.forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="border px-2 py-1">${r.tanggal}</td>
            <td class="border px-2 py-1">${r.laporan_pengiriman}</td>
            <td class="border px-2 py-1">${r.retur}</td>
            <td class="border px-2 py-1">${r.dikirim}</td>
            <td class="border px-2 py-1">${r.master_sa}</td>
            <td class="border px-2 py-1">${r.pengiriman}</td>
            <td class="border px-2 py-1">${formatRupiah(r.nominal_harus_dibayar)}</td>
            <td class="border px-2 py-1">${r.brimola_oleh}</td>
            <td class="border px-2 py-1">${formatRupiah(r.bayar_lewat_brimola)}</td>
            <td class="border px-2 py-1">${r.bukti_transfer}</td>
            <td class="border px-2 py-1">${formatRupiah(r.bagi_hasil)}</td>
          `;
          tbody.appendChild(tr);
        });

      } catch (err) {
        console.error("Error load rekap:", err);
      }
    }

    // Auto-load PTs saat halaman dibuka
    document.addEventListener("DOMContentLoaded", () => {
      const now = new Date();
      document.getElementById("month").value = now.getMonth() + 1;
      document.getElementById("year").value = now.getFullYear();

      loadPTs();

      document.getElementById("pt-select").addEventListener("change", e => {
        loadPangkalan(e.target.value);
      });
    });
  </script>
</body>
</html>
