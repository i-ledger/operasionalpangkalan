<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rekap Operasional â€” i-Shipping</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen p-6 font-sans">
  <div class="max-w-7xl mx-auto">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-semibold">Rekap Operasional</h1>
      <div id="spinner" class="hidden items-center space-x-2">
        <svg class="animate-spin h-6 w-6" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
          <path class="opacity-75" d="M4 12a8 8 0 018-8v8z" fill="currentColor"></path>
        </svg>
        <span>Loading...</span>
      </div>
    </header>

    <section class="bg-white p-4 rounded-lg shadow mb-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-medium">Nama PT</label>
          <select id="select-pt" class="mt-1 block w-full rounded-md border-gray-200"></select>
        </div>
        <div>
          <label class="block text-sm font-medium">Nama Pangkalan</label>
          <select id="select-pangkalan" class="mt-1 block w-full rounded-md border-gray-200"></select>
        </div>
        <div>
          <label class="block text-sm font-medium">Bulan</label>
          <select id="select-month" class="mt-1 block w-full rounded-md border-gray-200"></select>
        </div>
        <div>
          <label class="block text-sm font-medium">Tahun</label>
          <select id="select-year" class="mt-1 block w-full rounded-md border-gray-200"></select>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-slate-100 p-3 rounded">
          <div class="text-xs text-gray-500">DO yang dimiliki</div>
          <div id="do-owned" class="text-lg font-medium">-</div>
        </div>
        <div class="bg-slate-100 p-3 rounded">
          <div class="text-xs text-gray-500">Harga</div>
          <div id="price" class="text-lg font-medium">-</div>
        </div>
        <div class="bg-slate-100 p-3 rounded">
          <div class="text-xs text-gray-500">Total Penerimaan TBG Bulanan</div>
          <div id="total-penerimaan" class="text-lg font-medium">-</div>
        </div>
      </div>

      <div class="mt-4 flex items-center gap-2">
        <button id="btn-load" class="px-4 py-2 bg-blue-600 text-white rounded">Tampilkan Rekap</button>
        <button id="btn-export-csv" class="px-3 py-2 border rounded">Export CSV</button>
      </div>
    </section>

    <section class="bg-white p-4 rounded-lg shadow">
      <div class="overflow-auto">
        <table id="rekap-table" class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-3 py-2 text-left text-xs font-medium">Tanggal</th>
              <th class="px-3 py-2 text-left text-xs font-medium">Laporan Pengiriman Driver/Kernet</th>
              <th class="px-3 py-2 text-left text-xs font-medium">Retur</th>
              <th class="px-3 py-2 text-left text-xs font-medium">Dikirim Driver/Kernet</th>
              <th class="px-3 py-2 text-left text-xs font-medium">MASTER_SA</th>
              <th class="px-3 py-2 text-left text-xs font-medium">Pengiriman</th>
              <th class="px-3 py-2 text-left text-xs font-medium">Nominal yang harus dibayar</th>
              <th class="px-3 py-2 text-left text-xs font-medium">Brimola Oleh</th>
              <th class="px-3 py-2 text-left text-xs font-medium">Bayar Lewat Brimola</th>
              <th class="px-3 py-2 text-left text-xs font-medium">Bukti Transfer</th>
              <th class="px-3 py-2 text-left text-xs font-medium">Bagi Hasil</th>
              <th class="px-3 py-2 text-left text-xs font-medium text-blue-600">Total Pembayaran TBG</th>
            </tr>
          </thead>
          <tbody id="rekap-body" class="bg-white divide-y divide-gray-100"></tbody>
          <tfoot class="bg-gray-100 font-semibold">
            <tr>
              <td colspan="11" class="px-3 py-2 text-right">TOTAL</td>
              <td id="grand-total" class="px-3 py-2 text-blue-600">Rp 0</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>

  </div>

  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzAsjSiCT7aCZakABOm7GRjt4tTlnDBtWKu1fB2AA0LWlrdXjFzGz2gVhXPomFplX9u5w/exec';
    const SPINNER = document.getElementById('spinner');

    function showSpinner(){ SPINNER.classList.remove('hidden'); }
    function hideSpinner(){ SPINNER.classList.add('hidden'); }

    async function fetchJSON(url){
      showSpinner();
      try{ const res = await fetch(url); const j = await res.json(); hideSpinner(); return j;}
      catch(e){ hideSpinner(); console.error(e); alert('Gagal mengambil data'); return null }
    }

    function makeMonthOptions(){
      const sel = document.getElementById('select-month');
      const months = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
      months.forEach((m,i)=>{ const opt = document.createElement('option'); opt.value = i+1; opt.textContent = m; sel.appendChild(opt) });
    }
    function makeYearOptions(){
      const sel = document.getElementById('select-year');
      const yearNow = new Date().getFullYear();
      for(let y=yearNow-2;y<=yearNow+1;y++){ const opt=document.createElement('option'); opt.value=y; opt.textContent=y; sel.appendChild(opt);}
    }

    async function loadPTs(){
      const url = `${GAS_URL}?action=getPTs`; 
      const data = await fetchJSON(url); if(!data) return;
      const sel = document.getElementById('select-pt');
      sel.innerHTML = '';
      data.forEach(pt=>{ const o=document.createElement('option'); o.value=pt; o.textContent=pt; sel.appendChild(o) });
      sel.dispatchEvent(new Event('change'));
    }

    async function loadPangkalanForPT(pt){
      const url = `${GAS_URL}?action=getPangkalan&pt=${encodeURIComponent(pt)}`;
      const data = await fetchJSON(url); 
      const sel = document.getElementById('select-pangkalan');
      sel.innerHTML='';
      const empty = document.createElement('option'); empty.value='ALL'; empty.textContent='-- Semua Pangkalan --'; sel.appendChild(empty);
      data.forEach(r=>{ const o=document.createElement('option'); o.value=r; o.textContent=r; sel.appendChild(o); });
    }

    async function updateDOInfo(pt,pangkalan){
      const url = `${GAS_URL}?action=getDOInfo&pt=${encodeURIComponent(pt)}&pangkalan=${encodeURIComponent(pangkalan)}`;
      const d = await fetchJSON(url);
      if(!d) return;
      document.getElementById('do-owned').textContent = d.do_owned ?? '-';
      document.getElementById('price').textContent = d.price ? formatRupiah(d.price) : '-';
      document.getElementById('total-penerimaan').textContent = d.total_penerimaan ? formatRupiah(d.total_penerimaan) : '-';
    }

    function formatRupiah(val){ if(val==null) return '-'; return 'Rp ' + Number(val).toLocaleString('id-ID'); }

    async function loadRekap(){
      const pt = document.getElementById('select-pt').value;
      const pangkalan = document.getElementById('select-pangkalan').value;
      const month = document.getElementById('select-month').value;
      const year = document.getElementById('select-year').value;
      const url = `${GAS_URL}?action=getRekap&pt=${encodeURIComponent(pt)}&pangkalan=${encodeURIComponent(pangkalan)}&month=${month}&year=${year}`;
      const data = await fetchJSON(url);
      if(!data) return;
      renderTable(data.rows);
      document.getElementById('total-penerimaan').textContent = formatRupiah(data.total_penerimaan);
      document.getElementById('do-owned').textContent = data.do_owned ?? '-';
      document.getElementById('price').textContent = data.price ? formatRupiah(data.price) : '-';
    }

    function renderTable(rows){
      const tbody = document.getElementById('rekap-body');
      tbody.innerHTML='';
      let grandTotal = 0;

      rows.forEach(r=>{
        const totalTBG = (Number(r.nominal_harus_dibayar)||0) - (Number(r.bayar_lewat_brimola)||0) - (Number(r.bukti_transfer)||0);
        grandTotal += totalTBG;

        const tr = document.createElement('tr'); 
        tr.innerHTML = `
          <td class="px-3 py-2 text-sm">${r.tanggal}</td>
          <td class="px-3 py-2 text-sm">${r.laporan_pengiriman}</td>
          <td class="px-3 py-2 text-sm">${r.retur}</td>
          <td class="px-3 py-2 text-sm">${r.dikirim}</td>
          <td class="px-3 py-2 text-sm">${r.master_sa}</td>
          <td class="px-3 py-2 text-sm">${r.pengiriman}</td>
          <td class="px-3 py-2 text-sm">${formatRupiah(r.nominal_harus_dibayar)}</td>
          <td class="px-3 py-2 text-sm">${r.brimola_oleh}</td>
          <td class="px-3 py-2 text-sm">${formatRupiah(r.bayar_lewat_brimola)}</td>
          <td class="px-3 py-2 text-sm">${formatRupiah(r.bukti_transfer)}</td>
          <td class="px-3 py-2 text-sm">${formatRupiah(r.bagi_hasil)}</td>
          <td class="px-3 py-2 text-sm text-blue-600 font-semibold">${formatRupiah(totalTBG)}</td>
        `; 
        tbody.appendChild(tr);
      });

      document.getElementById('grand-total').textContent = formatRupiah(grandTotal);
    }

    document.getElementById('btn-load').addEventListener('click', async ()=>{ await loadRekap(); });
    document.getElementById('select-pt').addEventListener('change', async (e)=>{ await loadPangkalanForPT(e.target.value); await updateDOInfo(e.target.value, document.getElementById('select-pangkalan').value); });
    document.getElementById('select-pangkalan').addEventListener('change', async (e)=>{ await updateDOInfo(document.getElementById('select-pt').value, e.target.value); });

    // init
    makeMonthOptions(); makeYearOptions(); loadPTs();
  </script>
</body>
</html>
