<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rekap Pangkalan â€” i-Shipping</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Progress overlay */
    #loadingOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      flex-direction: column;
      font-family: sans-serif;
    }
    .progress-bar {
      width: 80%;
      max-width: 400px;
      height: 20px;
      background: #e5e7eb;
      border-radius: 9999px;
      overflow: hidden;
      margin-top: 10px;
    }
    .progress-bar-fill {
      height: 100%;
      width: 0%;
      background: #2563eb;
      transition: width 0.2s;
    }
  </style>
</head>
<body class="bg-blue-50 text-slate-900 p-4 sm:p-6">
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="hidden">
    <div class="text-lg font-medium text-blue-700">Memuat data...</div>
    <div class="progress-bar">
      <div id="progressFill" class="progress-bar-fill"></div>
    </div>
    <div id="progressText" class="mt-2 text-sm text-blue-600">0%</div>
  </div>

  <div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
      <h1 class="text-xl sm:text-2xl font-semibold text-blue-700">Rekap Pangkalan</h1>
      <a href="dashboard.html" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow text-sm sm:text-base">
        Dashboard
      </a>
    </div>

    <!-- Filter -->
    <div class="bg-white p-4 rounded shadow mb-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3 items-end">
      <div>
        <label class="block text-sm mb-1">Bulan</label>
        <select id="selMonth" class="w-full border rounded p-2 text-sm"></select>
      </div>
      <div>
        <label class="block text-sm mb-1">Tahun</label>
        <select id="selYear" class="w-full border rounded p-2 text-sm"></select>
      </div>
      <div class="flex flex-wrap gap-2 sm:col-span-2">
        <button id="btnLoad" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow text-sm">
          Muat Rekap
        </button>
        <button id="btnCSV" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow text-sm">
          Download CSV
        </button>
      </div>
    </div>

    <!-- Table -->
    <div class="bg-white rounded shadow p-2 sm:p-4">
      <div class="overflow-x-auto">
        <table id="tbl" class="min-w-full table-auto border-collapse text-sm sm:text-base">
          <thead>
            <tr class="bg-blue-100 text-left">
              <th class="p-2 border">#</th>
              <th class="p-2 border">Nama Pangkalan</th>
              <th class="p-2 border">Nama PT</th>
              <th class="p-2 border text-right">Penerimaan Bulan Ini</th>
              <th class="p-2 border text-right">Total Brimola</th>
              <th class="p-2 border text-right">Total Luar Brimola</th>
              <th class="p-2 border text-right">Total Bagi Hasil</th>
              <th class="p-2 border text-right">Sisa Refill</th>
              <th class="p-2 border text-right">Sisa Bagi Hasil</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <!-- rows -->
          </tbody>
          <tfoot>
            <tr class="bg-blue-50 font-semibold">
              <td colspan="3" class="p-2 border">TOTAL</td>
              <td id="totalPenerimaan" class="p-2 border text-right">0</td>
              <td id="totalBrimola" class="p-2 border text-right">Rp 0</td>
              <td id="totalLuar" class="p-2 border text-right">Rp 0</td>
              <td id="totalBagi" class="p-2 border text-right">Rp 0</td>
              <td id="totalSisaRefill" class="p-2 border text-right">Rp 0</td>
              <td id="totalSisaBagi" class="p-2 border text-right">Rp 0</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

<script>
const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbyvMQaxcO_g2UxIrbC_y2GlVov_exW6SiMH9eBfKPG6oO9SyWNUp3Id30xLPRGjA2nkOA/exec';
const $ = sel => document.querySelector(sel);
const money = v => {
  if (v === null || v === undefined) return 'Rp 0';
  const n = Number(v) || 0;
  return n.toLocaleString('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0});
};
const numberFmt = v => (Number(v) || 0);

// Loading overlay control
function showLoading() {
  $('#loadingOverlay').classList.remove('hidden');
  updateProgress(0);
  simulateProgress();
}
function hideLoading() {
  $('#loadingOverlay').classList.add('hidden');
}
function updateProgress(percent) {
  $('#progressFill').style.width = percent + '%';
  $('#progressText').textContent = percent + '%';
}
// fake smooth progress
function simulateProgress() {
  let p = 0;
  const interval = setInterval(()=>{
    if (p < 90) {
      p += Math.floor(Math.random()*5)+1;
      if(p>90) p=90;
      updateProgress(p);
    } else {
      clearInterval(interval);
    }
  },200);
}

async function fetchRekap(month, year){
  showLoading();
  return new Promise((resolve, reject)=>{
    try{
      const cbName='cbRekap'+Date.now();
      window[cbName]=(data)=>{
        updateProgress(100);
        setTimeout(hideLoading,300);
        resolve(data && data.rows?data.rows:[]);
        delete window[cbName]; script.remove();
      };
      const url=BACKEND_URL+'?action=getRekapSemuaPangkalan&month='+month+'&year='+year+'&callback='+cbName;
      const script=document.createElement('script');
      script.src=url;
      script.onerror=()=>{hideLoading();reject(new Error('Gagal load JSONP'));};
      document.body.appendChild(script);
    }catch(err){hideLoading();reject(err);}
  });
}

function renderTable(rows){
  const tbody=$('#tbody'); tbody.innerHTML='';
  let totPenerimaan=0, totBrim=0, totLuar=0, totBagi=0, totSisaRefill=0, totSisaBagi=0;
  rows.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.className=i%2===0?'':'bg-blue-50/30';
    const penerimaan=numberFmt(r.penerimaan);
    const b=numberFmt(r.total_brimola), l=numberFmt(r.total_luar_brimola),
          bh=numberFmt(r.total_bagi_hasil), sr=numberFmt(r.sisa_refill), sb=numberFmt(r.sisa_bagi_hasil);
    totPenerimaan+=penerimaan; totBrim+=b; totLuar+=l; totBagi+=bh; totSisaRefill+=sr; totSisaBagi+=sb;
    tr.innerHTML=`
      <td class="p-2 border">${i+1}</td>
      <td class="p-2 border">${r.nama_pangkalan||'-'}</td>
      <td class="p-2 border">${r.nama_pt||'-'}</td>
      <td class="p-2 border text-right">${penerimaan}</td>
      <td class="p-2 border text-right">${money(b)}</td>
      <td class="p-2 border text-right">${money(l)}</td>
      <td class="p-2 border text-right">${money(bh)}</td>
      <td class="p-2 border text-right">${money(sr)}</td>
      <td class="p-2 border text-right">${money(sb)}</td>`;
    tbody.appendChild(tr);
  });
  $('#totalPenerimaan').textContent=totPenerimaan;
  $('#totalBrimola').textContent=money(totBrim);
  $('#totalLuar').textContent=money(totLuar);
  $('#totalBagi').textContent=money(totBagi);
  $('#totalSisaRefill').textContent=money(totSisaRefill);
  $('#totalSisaBagi').textContent=money(totSisaBagi);
  window.__rekap_last=rows||[];
}

function rowsToCSV(rows){
  const header=['Nama Pangkalan','Nama PT','Penerimaan Bulan Ini','Total Brimola','Total Luar Brimola','Total Bagi Hasil','Sisa Refill','Sisa Bagi Hasil'];
  const lines=[header.join(',')];
  rows.forEach(r=>{
    const line=[`"${(r.nama_pangkalan||'').replace(/"/g,'""')}"`,`"${(r.nama_pt||'').replace(/"/g,'""')}"`,
      Number(r.penerimaan)||0,Number(r.total_brimola)||0,Number(r.total_luar_brimola)||0,
      Number(r.total_bagi_hasil)||0,Number(r.sisa_refill)||0,Number(r.sisa_bagi_hasil)||0].join(',');
    lines.push(line);
  });
  return lines.join('\n');
}

// Init
(function initMonthYear(){
  const selM=$('#selMonth'), selY=$('#selYear');
  const now=new Date();
  for (let m=1;m<=12;m++){
    const opt=document.createElement('option');
    opt.value=m;
    opt.textContent=m.toString().padStart(2,'0');
    if(m===(now.getMonth()+1)) opt.selected=true;
    selM.appendChild(opt);
  }
  const startYear=now.getFullYear()-3;
  for (let y=startYear;y<=now.getFullYear()+1;y++){
    const opt=document.createElement('option');
    opt.value=y; opt.textContent=y;
    if(y===now.getFullYear()) opt.selected=true;
    selY.appendChild(opt);
  }
})();

$('#btnLoad').addEventListener('click',async()=>{
  const rows=await fetchRekap($('#selMonth').value,$('#selYear').value);
  renderTable(rows);
});

$('#btnCSV').addEventListener('click',()=>{
  const rows=window.__rekap_last||[];
  if(!rows.length){alert('Belum ada data. Klik "Muat Rekap" dulu.');return;}
  const csv=rowsToCSV(rows), blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob), a=document.createElement('a');
  a.href=url; a.download=`rekap_pangkalan_${$('#selYear').value}_${$('#selMonth').value}.csv`;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

// Auto load awal
(async function autoLoad(){
  const rows=await fetchRekap($('#selMonth').value,$('#selYear').value);
  renderTable(rows);
})();
</script>
</body>
</html>
