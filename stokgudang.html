<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rekap SA JH P</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #rekap-table th, #rekap-table td { border:1px solid #ccc; padding:4px; text-align:center; }
    #rekap-table th { background:#f3f4f6; position:sticky; top:0; z-index:10; }
    #rekap-table tbody tr:nth-child(even){ background:#f9fafb; }
  </style>
</head>
<body class="p-4 bg-gray-50">

  <h1 class="text-xl font-bold mb-4">Rekap SA, JH, P</h1>

  <!-- Filter -->
  <div class="flex flex-wrap gap-2 mb-4">
    <input id="filterPT" type="text" placeholder="Filter Nama PT" class="border p-2 rounded">
    <input id="filterPangkalan" type="text" placeholder="Filter Nama Pangkalan" class="border p-2 rounded">
    <input id="filterBulan" type="month" class="border p-2 rounded">
    <button onclick="loadData()" class="bg-blue-500 text-white px-4 py-2 rounded">Terapkan</button>
  </div>

  <!-- Tabel -->
  <div class="overflow-auto">
    <table id="rekap-table" class="min-w-[1200px] border-collapse text-sm"></table>
  </div>

  <!-- Total -->
  <div class="mt-4 font-bold" id="rekap-total"></div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyDMjAyLmZhyJOnNlZVOj4m4p6zFntmjgaUOXow7nKIeFrr3G8iaKXCJbrcAwiL9lffKA/exec"; // ganti sama URL GAS lu

    async function loadData() {
      const bulan = document.getElementById("filterBulan").value || new Date().toISOString().slice(0,7);
      const namaPT = document.getElementById("filterPT").value.toLowerCase();
      const namaPangkalan = document.getElementById("filterPangkalan").value.toLowerCase();

      // ambil data dari GAS
      const res = await fetch(`${API_URL}?action=getRekap&bulan=${bulan}`);
      const data = await res.json();

      // filter
      let filtered = data.filter(d => 
        (!namaPT || d.namaPT.toLowerCase().includes(namaPT)) &&
        (!namaPangkalan || d.namaPangkalan.toLowerCase().includes(namaPangkalan))
      );

      renderTable(filtered, bulan);
    }

    function renderTable(data, bulan) {
      const table = document.getElementById("rekap-table");
      table.innerHTML = "";

      const daysInMonth = new Date(bulan.split("-")[0], bulan.split("-")[1], 0).getDate();

      // Header
      let thead = "<tr><th rowspan='2'>Nama Pangkalan</th><th rowspan='2'>Nama PT</th>";
      for(let d=1; d<=daysInMonth; d++){
        thead += `<th colspan="3">${String(d).padStart(2,"0")}/${bulan.split("-")[1]}/${bulan.split("-")[0]}</th>`;
      }
      thead += "</tr><tr>";
      for(let d=1; d<=daysInMonth; d++){
        thead += "<th>SA</th><th>JH</th><th>P</th>";
      }
      thead += "</tr>";
      table.innerHTML += `<thead>${thead}</thead>`;

      // Body
      let tbody = "";
      let totalSA = 0, totalJH = 0, totalP = 0;

      data.forEach(row => {
        tbody += `<tr><td>${row.namaPangkalan}</td><td>${row.namaPT}</td>`;
        for(let d=1; d<=daysInMonth; d++){
          const key = String(d).padStart(2,"0");
          const SA = row.SA[key] || 0;
          const JH = row.JH[key] || 0;
          const P = row.P[key] || 0;
          totalSA += SA;
          totalJH += JH;
          totalP += P;
          tbody += `<td>${SA}</td><td>${JH}</td><td>${P}</td>`;
        }
        tbody += "</tr>";
      });

      table.innerHTML += `<tbody>${tbody}</tbody>`;

      document.getElementById("rekap-total").innerText = 
        `Total SA: ${totalSA} | Total JH: ${totalJH} | Total P: ${totalP}`;
    }

    loadData();
  </script>
</body>
</html>
